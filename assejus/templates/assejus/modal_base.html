{% load static %}
<link rel="stylesheet" href="{% static 'assejus/css/error-styles.css' %}">

<!-- Modal Base para Formul√°rios ASEJUS -->
<div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="formModalLabel">
                    <i class="fas fa-edit me-2"></i>T√≠tulo do Modal
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="formModalBody">
                <!-- Conte√∫do do formul√°rio ser√° inserido aqui -->
                <div class="text-center p-5">
                    <p class="text-muted">Modal base carregado com sucesso!</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-2"></i>Cancelar
                </button>
                <button type="button" class="btn btn-primary" id="assejusModalSubmit">
                    <i class="fas fa-save me-2"></i>Salvar
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Detalhes do Advogado -->
<div class="modal fade" id="advogadoDetailModal" tabindex="-1" aria-labelledby="advogadoDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="advogadoDetailModalLabel">Detalhes do Advogado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="advogadoDetailModalBody">
                <!-- Conte√∫do ser√° carregado via AJAX -->
                <div class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3 text-muted">Carregando detalhes do advogado...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Fechar</button>
                <button type="button" class="btn btn-primary" id="editAdvogadoBtn">Editar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Confirma√ß√£o -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Confirma√ß√£o</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Mensagem de confirma√ß√£o ser√° inserida aqui -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="confirmModalConfirm">Confirmar</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal de Mensagem -->
<div class="modal fade" id="messageModal" tabindex="-1" aria-labelledby="messageModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="messageModalLabel">Mensagem</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="messageModalBody">
                <!-- Mensagem ser√° inserida aqui -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Sistema de Visualiza√ß√£o de Erros -->
<script src="{% static 'js/error-handling.js' %}"></script>

<script>
console.log('üöÄ Template base de modais ASEJUS carregado');

// Fun√ß√£o para abrir modal de formul√°rio
window.openFormModal = function(titulo, conteudo, formId, actionUrl) {
    console.log('üöÄ openFormModal chamada:', { titulo, formId, actionUrl });
    
    // Atualizar t√≠tulo e conte√∫do do modal
    const titleEl = document.getElementById('formModalLabel');
    const bodyEl = document.getElementById('formModalBody');
    
    if (titleEl) titleEl.innerHTML = titulo;
    if (bodyEl) bodyEl.innerHTML = conteudo;
    
    // Aguardar um pouco para o DOM ser atualizado
    setTimeout(() => {
        // Configurar o formul√°rio
        const form = document.getElementById(formId);
        console.log('üîç Procurando formul√°rio com ID:', formId);
        console.log('üîç Formul√°rio encontrado:', form);
        
        if (form && actionUrl) {
            form.action = actionUrl;
            console.log('‚úÖ Formul√°rio configurado com action:', form.action);
            
            // Configurar o bot√£o salvar
            const submitBtn = document.getElementById('assejusModalSubmit');
            console.log('üîç Bot√£o salvar encontrado:', submitBtn);
            
            if (submitBtn) {
                // Remover listeners anteriores
                submitBtn.onclick = null;
                
                // Adicionar novo listener
                submitBtn.onclick = function(e) {
                    e.preventDefault();
                    console.log('üîò Bot√£o salvar clicado!');
                    console.log('üîç Formul√°rio a ser enviado:', form);
                    console.log('üîç Action do formul√°rio:', form.action);
                    
                    if (form) {
                        console.log('‚úÖ Chamando submitForm...');
                        submitForm(form);
                    } else {
                        console.error('‚ùå Formul√°rio n√£o encontrado no onclick');
                    }
                };
                
                console.log('‚úÖ Bot√£o salvar configurado com sucesso');
            } else {
                console.error('‚ùå Bot√£o salvar n√£o encontrado');
            }
        } else {
            console.error('‚ùå Formul√°rio ou actionUrl inv√°lidos');
            console.error('Form:', form);
            console.error('ActionUrl:', actionUrl);
        }
    }, 100);
    
    // Abrir modal
    const modalElement = document.getElementById('formModal');
    if (modalElement) {
        const modal = new bootstrap.Modal(modalElement);
        modal.show();
        console.log('‚úÖ Modal aberto');
    }
};

// Fun√ß√£o para submeter formul√°rio
window.submitForm = function(form) {
    console.log('üöÄ submitForm chamada');
    console.log('üîç Formul√°rio recebido:', form);
    console.log('üîç Action do formul√°rio:', form.action);
    console.log('üîç ID do formul√°rio:', form.id);
    console.log('üîç M√©todo do formul√°rio:', form.method);
    
    if (!form) {
        console.error('‚ùå Formul√°rio √© null ou undefined');
        alert('Erro: Formul√°rio inv√°lido');
        return;
    }
    
    if (!form.action) {
        console.error('‚ùå Formul√°rio n√£o tem action definida');
        alert('Erro: URL de envio n√£o definida');
        return;
    }
    
    // Verificar se o formul√°rio tem campos
    const formFields = form.querySelectorAll('input, select, textarea');
    console.log('üîç Campos encontrados no formul√°rio:', formFields.length);
    
    // Verificar CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]');
    if (!csrfToken) {
        console.error('‚ùå CSRF token n√£o encontrado');
        alert('Erro: Token de seguran√ßa n√£o encontrado');
        return;
    }
    
    console.log('‚úÖ CSRF token encontrado');
    
    const formData = new FormData(form);
    
    // Log dos dados do formul√°rio
    console.log('üîç Dados do formul√°rio:');
    for (let [key, value] of formData.entries()) {
        console.log(`  ${key}: ${value}`);
    }
    
    console.log('üì§ Enviando requisi√ß√£o para:', form.action);
    
    // Mostrar indicador de carregamento no bot√£o
    let submitBtn = document.getElementById('assejusModalSubmit');
    if (!submitBtn) {
        submitBtn = document.querySelector('#formModal .modal-footer .btn-primary');
    }
    if (!submitBtn) {
        submitBtn = document.querySelector('#formModal .modal-footer button[type="submit"]');
    }
    if (!submitBtn) {
        submitBtn = document.querySelector('.modal.show .modal-footer .btn-primary');
    }
    
    console.log('üîç Bot√£o submit encontrado:', submitBtn);
    
    if (submitBtn) {
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';
        submitBtn.disabled = true;
        
        // Restaurar bot√£o ap√≥s resposta
        const restoreButton = () => {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        };
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken.value
            }
        })
        .then(response => {
            console.log('üì• Resposta recebida:', response);
            console.log('üìä Status:', response.status);
            console.log('üìä OK:', response.ok);
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            return response.json();
        })
        .then(data => {
            console.log('‚úÖ Dados da resposta:', data);
            restoreButton();
            
            if (data.success) {
                console.log('üéâ Sucesso! Mensagem:', data.message);
                alert('Sucesso: ' + data.message);
                
                if (data.reload) {
                    console.log('üîÑ Recarregando p√°gina...');
                    location.reload();
                } else {
                    console.log('‚úÖ P√°gina n√£o ser√° recarregada');
                    // Fechar modal
                    const modalElement = document.getElementById('formModal');
                    if (modalElement) {
                        const modal = bootstrap.Modal.getInstance(modalElement);
                        if (modal) {
                            modal.hide();
                        }
                    }
                }
            } else {
                console.error('‚ùå Erro na resposta:', data.message);
                
                // Log detalhado dos erros
                if (data.errors) {
                    console.error('‚ùå Detalhes dos erros:');
                    Object.keys(data.errors).forEach(fieldName => {
                        const fieldErrors = data.errors[fieldName];
                        console.error(`  ‚Ä¢ ${fieldName}: ${fieldErrors.join(', ')}`);
                    });
                    
                    // Mostrar resumo dos erros
                    if (data.error_count) {
                        console.error(`üìä Total de erros: ${data.error_count}`);
                    }
                    if (data.error_summary) {
                        console.error(`üìã Resumo: ${data.error_summary}`);
                    }
                } else {
                    console.error('‚ùå Sem detalhes dos erros dispon√≠veis');
                    console.error('üìä Resposta completa:', data);
                }
                
                // Se houver form_html na resposta, atualizar o modal
                if (data.form_html) {
                    const modalBody = document.getElementById('formModalBody');
                    if (modalBody) {
                        modalBody.innerHTML = data.form_html;
                        console.log('‚úÖ Formul√°rio atualizado com erros');
                        
                        // Debug: verificar estrutura do modal
                        console.log('üîç Debug do modal:');
                        console.log('  - Modal body encontrado:', !!document.getElementById('formModalBody'));
                        console.log('  - Modal body HTML length:', document.getElementById('formModalBody')?.innerHTML?.length);
                        console.log('  - Modal body children count:', document.getElementById('formModalBody')?.children?.length);
                        
                        // Exibir resumo dos erros no topo do modal
                        if (data.errors && Object.keys(data.errors).length > 0) {
                            console.log('üîç Chamando showErrorSummaryInModal...');
                            showErrorSummaryInModal(data.errors, data.error_count, data.error_summary);
                        }
                        
                        // Aplicar estilos de erro aos campos com pequeno delay para garantir DOM atualizado
                        setTimeout(() => {
                            console.log('üîç Chamando applyErrorStylesToFields...');
                            applyErrorStylesToFields(data.errors);
                            
                            // Rolar para o primeiro campo com erro
                            console.log('üîç Chamando scrollToFirstError...');
                            scrollToFirstError();
                        }, 100);
                    }
                } else {
                    // Se n√£o houver form_html, mostrar erro em um alerta estilizado
                    showErrorAlertInModal(data.message, data.errors);
                }
            }
        })
        .catch(error => {
            console.error('‚ùå Erro na requisi√ß√£o:', error);
            console.error('‚ùå Stack trace:', error.stack);
            restoreButton();
            showErrorAlertInModal('Erro ao processar solicita√ß√£o: ' + error.message);
        });
    } else {
        console.error('‚ùå Bot√£o submit n√£o encontrado');
        console.error('‚ùå Tentando fallback...');
        
        // Fallback sem indicador de carregamento
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': csrfToken.value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Sucesso: ' + data.message);
                if (data.reload) {
                    location.reload();
                }
            } else {
                alert('Erro: ' + data.message);
            }
        })
        .catch(error => {
            console.error('‚ùå Erro na requisi√ß√£o:', error);
            alert('Erro ao processar solicita√ß√£o: ' + error.message);
        });
    }
};

console.log('‚úÖ Fun√ß√µes b√°sicas carregadas');

// ============================================================================
// FUN√á√ïES PARA EXIBIR ERROS NO MODAL
// ============================================================================

// Fun√ß√£o para exibir resumo de erros no topo do modal
function showErrorSummaryInModal(errors, errorCount, errorSummary) {
    console.log('üîç showErrorSummaryInModal chamada com:', { errors, errorCount, errorSummary });
    
    const modalBody = document.getElementById('formModalBody');
    if (!modalBody) {
        console.warn('‚ö†Ô∏è Modal body n√£o encontrado');
        return;
    }
    
    // Remover alertas de erro anteriores
    const existingAlerts = modalBody.querySelectorAll('.alert-danger.border-danger');
    existingAlerts.forEach(alert => alert.remove());
    
    // Criar alerta de erro estilizado
    const errorAlert = document.createElement('div');
    errorAlert.className = 'alert alert-danger border-danger mb-4';
    errorAlert.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-exclamation-triangle fa-2x me-3 text-danger"></i>
            <div>
                <h5 class="alert-heading mb-2">
                    <i class="fas fa-times-circle me-2"></i>Formul√°rio com Erros de Valida√ß√£o
                </h5>
                <p class="mb-2">${errorSummary || `Foram encontrados ${errorCount || Object.keys(errors).length} erro(s) no formul√°rio.`}</p>
                <p class="mb-0 small text-muted">Por favor, corrija os campos destacados em vermelho e tente novamente.</p>
            </div>
        </div>
    `;
    
    // Inserir no topo do modal
    modalBody.insertBefore(errorAlert, modalBody.firstChild);
    console.log('‚úÖ Resumo de erros inserido no modal');
    
    // Adicionar bot√£o para fechar o alerta
    const closeButton = document.createElement('button');
    closeButton.type = 'button';
    closeButton.className = 'btn-close position-absolute top-0 end-0 m-3';
    closeButton.setAttribute('aria-label', 'Fechar');
    closeButton.onclick = () => errorAlert.remove();
    errorAlert.style.position = 'relative';
    errorAlert.appendChild(closeButton);
}

// Fun√ß√£o para exibir alerta de erro quando n√£o h√° form_html
function showErrorAlertInModal(message, errors = null) {
    const modalBody = document.getElementById('formModalBody');
    if (!modalBody) return;
    
    let errorContent = `
        <div class="alert alert-danger border-danger">
            <div class="d-flex align-items-center">
                <i class="fas fa-exclamation-triangle fa-2x me-3 text-danger"></i>
                <div>
                    <h5 class="alert-heading mb-2">
                        <i class="fas fa-times-circle me-2"></i>Erro no Sistema
                    </h5>
                    <p class="mb-2">${message}</p>
    `;
    
    // Se houver erros espec√≠ficos, mostrar detalhes
    if (errors && Object.keys(errors).length > 0) {
        errorContent += `
            <hr class="my-3">
            <h6 class="mb-2">Detalhes dos Erros:</h6>
            <ul class="mb-0 small">
        `;
        
        Object.keys(errors).forEach(fieldName => {
            const fieldErrors = errors[fieldName];
            fieldErrors.forEach(error => {
                errorContent += `<li><strong>${fieldName}:</strong> ${error}</li>`;
            });
        });
        
        errorContent += `</ul>`;
    }
    
    errorContent += `
                </div>
            </div>
            <div class="mt-3">
                <button type="button" class="btn btn-outline-danger btn-sm" onclick="closeModal()">
                    <i class="fas fa-times me-2"></i>Fechar Modal
                </button>
                <button type="button" class="btn btn-primary btn-sm ms-2" onclick="retryForm()">
                    <i class="fas fa-redo me-2"></i>Tentar Novamente
                </button>
            </div>
        </div>
    `;
    
    modalBody.innerHTML = errorContent;
}

// Fun√ß√£o para aplicar estilos de erro aos campos
function applyErrorStylesToFields(errors) {
    if (!errors) {
        console.warn('‚ö†Ô∏è Nenhum erro fornecido para applyErrorStylesToFields');
        return;
    }
    
    console.log('üîç Aplicando estilos de erro para:', errors);
    console.log('üîç Total de campos com erro:', Object.keys(errors).length);
    
    let camposProcessados = 0;
    let camposComErro = 0;
    
    Object.keys(errors).forEach(fieldName => {
        console.log(`üîç Procurando campo: ${fieldName}`);
        
        // Tentar diferentes seletores para encontrar o campo
        let field = document.querySelector(`[name="${fieldName}"]`);
        
        if (!field) {
            // Tentar por ID
            field = document.getElementById(fieldName);
        }
        
        if (!field) {
            // Tentar por nome com diferentes varia√ß√µes
            field = document.querySelector(`input[name="${fieldName}"], select[name="${fieldName}"], textarea[name="${fieldName}"]`);
        }
        
        if (field) {
            console.log(`‚úÖ Campo encontrado: ${fieldName}`, field);
            camposComErro++;
            
            // Adicionar classe de erro
            field.classList.add('is-invalid');
            
            // Adicionar classe de erro ao grupo do campo
            const formGroup = field.closest('.form-group, .mb-3, .col-md-6, .col-md-4, .col-md-3');
            if (formGroup) {
                formGroup.classList.add('has-error');
                console.log(`‚úÖ Grupo do campo marcado com erro:`, formGroup);
            }
            
            // Criar mensagem de erro abaixo do campo
            createFieldErrorMessage(field, errors[fieldName]);
        } else {
            console.warn(`‚ö†Ô∏è Campo n√£o encontrado: ${fieldName}`);
        }
        
        camposProcessados++;
    });
    
    console.log(`üìä Resumo: ${camposProcessados} campos processados, ${camposComErro} campos com erro aplicado`);
}

// Fun√ß√£o para criar mensagem de erro para um campo espec√≠fico
function createFieldErrorMessage(field, errorMessages) {
    console.log(`üîç Criando mensagem de erro para campo:`, field.name, errorMessages);
    
    if (!field || !field.parentNode) {
        console.warn(`‚ö†Ô∏è Campo ou parentNode inv√°lido para:`, field);
        return;
    }
    
    // Remover mensagens de erro anteriores
    const existingError = field.parentNode.querySelector('.invalid-feedback');
    if (existingError) {
        existingError.remove();
        console.log(`‚úÖ Mensagem de erro anterior removida`);
    }
    
    // Criar nova mensagem de erro
    const errorDiv = document.createElement('div');
    errorDiv.className = 'invalid-feedback d-block text-danger mt-1';
    
    if (Array.isArray(errorMessages)) {
        errorMessages.forEach((error, index) => {
            const errorItem = document.createElement('div');
            errorItem.innerHTML = `<i class="fas fa-times-circle me-1"></i>${error}`;
            errorDiv.appendChild(errorItem);
        });
    } else {
        errorDiv.innerHTML = `<i class="fas fa-times-circle me-1"></i>${errorMessages}`;
    }
    
    // Inserir ap√≥s o campo
    const parentNode = field.parentNode;
    if (parentNode) {
        parentNode.appendChild(errorDiv);
        console.log(`‚úÖ Mensagem de erro inserida ap√≥s campo:`, field.name);
        
        // Verificar se foi inserido corretamente
        const insertedError = parentNode.querySelector('.invalid-feedback');
        if (insertedError) {
            console.log(`‚úÖ Mensagem de erro confirmada no DOM:`, insertedError);
        } else {
            console.warn(`‚ö†Ô∏è Mensagem de erro n√£o encontrada no DOM ap√≥s inser√ß√£o`);
        }
    } else {
        console.warn(`‚ö†Ô∏è N√£o foi poss√≠vel inserir mensagem de erro para:`, field.name);
    }
}

// Fun√ß√£o para rolar para o primeiro campo com erro
function scrollToFirstError() {
    const firstErrorField = document.querySelector('.is-invalid');
    if (firstErrorField) {
        firstErrorField.scrollIntoView({ 
            behavior: 'smooth', 
            block: 'center' 
        });
        firstErrorField.focus();
    }
}

// Fun√ß√£o para fechar o modal
function closeModal() {
    const modalElement = document.getElementById('formModal');
    if (modalElement) {
        const modal = bootstrap.Modal.getInstance(modalElement);
        if (modal) {
            modal.hide();
        }
    }
}

// Fun√ß√£o para tentar novamente
function retryForm() {
    // Recarregar o formul√°rio
    if (typeof retryFormSubmission === 'function') {
        retryFormSubmission();
    } else {
        // Fallback: recarregar a p√°gina
        location.reload();
    }
}
</script>
