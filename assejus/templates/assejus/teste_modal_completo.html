{% extends 'base.html' %}
{% load static %}

{% block title %}Teste Modal Completo{% endblock %}

{% block extra_css %}
<style>
    body {
        padding: 20px;
        background-color: #f8f9fa;
    }
    
    .test-container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 0 20px rgba(0,0,0,0.1);
    }
    
    .btn-test {
        margin: 10px;
        padding: 15px 30px;
        font-size: 16px;
    }
    
    /* Estilos para campos v√°lidos */
    .form-control.is-valid,
    .form-select.is-valid {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }

    .form-group.has-success .form-control,
    .form-group.has-success .form-select {
        border-color: #28a745;
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
    }

    .form-group.has-success .form-label {
        color: #28a745;
        font-weight: 600;
    }

    .valid-feedback {
        display: block;
        color: #28a745;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    /* Estilos para campos inv√°lidos */
    .form-control.is-invalid,
    .form-select.is-invalid {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    .form-group.has-error .form-control,
    .form-group.has-error .form-select {
        border-color: #dc3545;
        box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    .form-group.has-error .form-label {
        color: #dc3545;
        font-weight: 600;
    }

    .invalid-feedback {
        display: block;
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    /* Resumo de erros */
    .error-summary {
        border-left: 4px solid #dc3545;
        background-color: #f8d7da;
        border-color: #f5c6cb;
    }

    /* Anima√ß√£o de erro */
    .field-error {
        animation: errorShake 0.5s ease-in-out;
    }

    @keyframes errorShake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
    }
</style>
{% endblock %}

{% block content %}
<div class="test-container">
    <h1 class="text-center mb-4">
        <i class="fas fa-test-tube text-primary me-2"></i>
        Teste do Modal Completo
    </h1>
    
    <div class="text-center mb-4">
        <p class="lead">Clique no bot√£o abaixo para abrir o modal de advogado completo:</p>
        <button type="button" class="btn btn-primary btn-lg btn-test" data-bs-toggle="modal" data-bs-target="#advogadoModal">
            <i class="fas fa-plus me-2"></i>Abrir Modal de Advogado
        </button>
    </div>
    
    <div class="alert alert-info">
        <h5><i class="fas fa-info-circle me-2"></i>Instru√ß√µes:</h5>
        <ul class="mb-0">
            <li>Clique no bot√£o acima para abrir o modal</li>
            <li>O modal deve mostrar todos os campos organizados em se√ß√µes</li>
            <li>Clique em "Testar Valida√ß√£o" para ver as mensagens de erro</li>
            <li>Deixe campos vazios e clique em salvar para testar valida√ß√£o</li>
            <li>Verifique se todos os 13 campos obrigat√≥rios est√£o presentes</li>
        </ul>
    </div>
    
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h6 class="mb-0"><i class="fas fa-check-circle me-2"></i>O que deve funcionar:</h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Modal abre corretamente</li>
                        <li>Todos os campos est√£o vis√≠veis</li>
                        <li>Valida√ß√£o em tempo real</li>
                        <li>Mensagens de erro inline</li>
                        <li>Resumo de erros no topo</li>
                        <li>Bot√£o "Testar Valida√ß√£o"</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card">
                <div class="card-header bg-warning text-dark">
                    <h6 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Problemas comuns:</h6>
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li>Modal n√£o abre</li>
                        <li>Campos n√£o aparecem</li>
                        <li>Valida√ß√£o n√£o funciona</li>
                        <li>JavaScript com erro</li>
                        <li>CSS n√£o carrega</li>
                        <li>Formul√°rio incompleto</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para Criar/Editar Advogado -->
<div class="modal fade" id="advogadoModal" tabindex="-1" aria-labelledby="advogadoModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <!-- Cabe√ßalho do Modal -->
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="advogadoModalLabel">
                    <i class="fas fa-plus me-2"></i>Novo Advogado
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>

            <!-- Corpo do Modal -->
            <div class="modal-body">
                <!-- Resumo de Erros -->
                <div id="errorSummary" class="alert alert-danger error-summary" style="display: none;">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <div>
                            <strong>Erros de Valida√ß√£o:</strong>
                            <div id="errorSummaryText"></div>
                        </div>
                    </div>
                </div>

                <!-- Formul√°rio -->
                <form id="advogadoForm" method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <!-- Informa√ß√µes Pessoais -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-user me-2"></i>Informa√ß√µes Pessoais
                            </h6>
                        </div>
                        
                        <!-- Nome -->
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                <label for="nome" class="form-label">
                                    <i class="fas fa-user me-1"></i>Nome Completo *
                                </label>
                                <input type="text" class="form-control" id="nome" name="nome" placeholder="Digite o nome completo">
                                <div class="invalid-feedback" id="nome-error"></div>
                                <div class="valid-feedback" id="nome-success"></div>
                            </div>
                        </div>

                        <!-- CPF -->
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                <label for="cpf" class="form-label">
                                    <i class="fas fa-id-card me-1"></i>CPF *
                                </label>
                                <input type="text" class="form-control" id="cpf" name="cpf" placeholder="000.000.000-00">
                                <div class="invalid-feedback" id="cpf-error"></div>
                                <div class="valid-feedback" id="cpf-success"></div>
                            </div>
                        </div>

                        <!-- OAB -->
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                <label for="oab" class="form-label">
                                    <i class="fas fa-gavel me-1"></i>N√∫mero OAB *
                                </label>
                                <input type="text" class="form-control" id="oab" name="oab" placeholder="Digite o n√∫mero da OAB">
                                <div class="invalid-feedback" id="oab-error"></div>
                                <div class="valid-feedback" id="oab-success"></div>
                            </div>
                        </div>

                        <!-- UF OAB -->
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                <label for="uf_oab" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>UF OAB *
                                </label>
                                <select class="form-select" id="uf_oab" name="uf_oab">
                                    <option value="">---------</option>
                                    <option value="AC">Acre</option>
                                    <option value="AL">Alagoas</option>
                                    <option value="AP">Amap√°</option>
                                    <option value="AM">Amazonas</option>
                                    <option value="BA">Bahia</option>
                                    <option value="CE">Cear√°</option>
                                    <option value="DF">Distrito Federal</option>
                                    <option value="ES">Esp√≠rito Santo</option>
                                    <option value="GO">Goi√°s</option>
                                    <option value="MA">Maranh√£o</option>
                                    <option value="MT">Mato Grosso</option>
                                    <option value="MS">Mato Grosso do Sul</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="PA">Par√°</option>
                                    <option value="PB">Para√≠ba</option>
                                    <option value="PR">Paran√°</option>
                                    <option value="PE">Pernambuco</option>
                                    <option value="PI">Piau√≠</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="RN">Rio Grande do Norte</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="RO">Rond√¥nia</option>
                                    <option value="RR">Roraima</option>
                                    <option value="SC">Santa Catarina</option>
                                    <option value="SP">S√£o Paulo</option>
                                    <option value="SE">Sergipe</option>
                                    <option value="TO">Tocantins</option>
                                </select>
                                <div class="invalid-feedback" id="uf_oab-error"></div>
                                <div class="valid-feedback" id="uf_oab-success"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Informa√ß√µes de Contato -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-address-book me-2"></i>Informa√ß√µes de Contato
                            </h6>
                        </div>
                        
                        <!-- E-mail -->
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                <label for="email" class="form-label">
                                    <i class="fas fa-envelope me-1"></i>E-mail *
                                </label>
                                <input type="email" class="form-control" id="email" name="email" placeholder="exemplo@email.com">
                                <div class="invalid-feedback" id="email-error"></div>
                                <div class="valid-feedback" id="email-success"></div>
                            </div>
                        </div>

                        <!-- Telefone -->
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                <label for="telefone" class="form-label">
                                    <i class="fas fa-phone me-1"></i>Telefone *
                                </label>
                                <input type="tel" class="form-control" id="telefone" name="telefone" placeholder="(00) 00000-0000">
                                <div class="invalid-feedback" id="telefone-error"></div>
                                <div class="valid-feedback" id="telefone-success"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Endere√ßo -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-map me-2"></i>Endere√ßo
                            </h6>
                        </div>
                        
                        <!-- Endere√ßo -->
                        <div class="col-12 mb-3">
                            <div class="form-group">
                                <label for="endereco" class="form-label">
                                    <i class="fas fa-road me-1"></i>Endere√ßo Completo *
                                </label>
                                <input type="text" class="form-control" id="endereco" name="endereco" placeholder="Rua, n√∫mero, bairro">
                                <div class="invalid-feedback" id="endereco-error"></div>
                                <div class="valid-feedback" id="endereco-success"></div>
                            </div>
                        </div>

                        <!-- Cidade -->
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                <label for="cidade" class="form-label">
                                    <i class="fas fa-city me-1"></i>Cidade *
                                </label>
                                <input type="text" class="form-control" id="cidade" name="cidade" placeholder="Nome da cidade">
                                <div class="invalid-feedback" id="cidade-error"></div>
                                <div class="valid-feedback" id="cidade-success"></div>
                            </div>
                        </div>

                        <!-- Estado -->
                        <div class="col-md-3 mb-3">
                            <div class="form-group">
                                <label for="estado" class="form-label">
                                    <i class="fas fa-map-marker me-1"></i>Estado *
                                </label>
                                <select class="form-select" id="estado" name="estado">
                                    <option value="">---------</option>
                                    <option value="AC">Acre</option>
                                    <option value="AL">Alagoas</option>
                                    <option value="AP">Amap√°</option>
                                    <option value="AM">Amazonas</option>
                                    <option value="BA">Bahia</option>
                                    <option value="CE">Cear√°</option>
                                    <option value="DF">Distrito Federal</option>
                                    <option value="ES">Esp√≠rito Santo</option>
                                    <option value="GO">Goi√°s</option>
                                    <option value="MA">Maranh√£o</option>
                                    <option value="MT">Mato Grosso</option>
                                    <option value="MS">Mato Grosso do Sul</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="PA">Par√°</option>
                                    <option value="PB">Para√≠ba</option>
                                    <option value="PR">Paran√°</option>
                                    <option value="PE">Pernambuco</option>
                                    <option value="PI">Piau√≠</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="RN">Rio Grande do Norte</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="RO">Rond√¥nia</option>
                                    <option value="RR">Roraima</option>
                                    <option value="SC">Santa Catarina</option>
                                    <option value="SP">S√£o Paulo</option>
                                    <option value="SE">Sergipe</option>
                                    <option value="TO">Tocantins</option>
                                </select>
                                <div class="invalid-feedback" id="estado-error"></div>
                                <div class="valid-feedback" id="estado-success"></div>
                            </div>
                        </div>

                        <!-- CEP -->
                        <div class="col-md-3 mb-3">
                            <div class="form-group">
                                <label for="cep" class="form-label">
                                    <i class="fas fa-mail-bulk me-1"></i>CEP *
                                </label>
                                <input type="text" class="form-control" id="cep" name="cep" placeholder="00000-000">
                                <div class="invalid-feedback" id="cep-error"></div>
                                <div class="valid-feedback" id="cep-success"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Informa√ß√µes Profissionais -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h6 class="text-primary border-bottom pb-2 mb-3">
                                <i class="fas fa-briefcase me-2"></i>Informa√ß√µes Profissionais
                            </h6>
                        </div>
                        
                        <!-- Data de Inscri√ß√£o OAB -->
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                <label for="data_inscricao_oab" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>Data de Inscri√ß√£o OAB *
                                </label>
                                <input type="date" class="form-control" id="data_inscricao_oab" name="data_inscricao_oab">
                                <div class="invalid-feedback" id="data_inscricao_oab-error"></div>
                                <div class="valid-feedback" id="data_inscricao_oab-success"></div>
                            </div>
                        </div>

                        <!-- Anos de Experi√™ncia -->
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                <label for="experiencia_anos" class="form-label">
                                    <i class="fas fa-clock me-1"></i>Anos de Experi√™ncia *
                                </label>
                                <input type="number" class="form-control" id="experiencia_anos" name="experiencia_anos" placeholder="0" min="0" max="100">
                                <div class="invalid-feedback" id="experiencia_anos-error"></div>
                                <div class="valid-feedback" id="experiencia_anos-success"></div>
                            </div>
                        </div>

                        <!-- Situa√ß√£o -->
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                <label for="situacao" class="form-label">
                                    <i class="fas fa-info-circle me-1"></i>Situa√ß√£o *
                                </label>
                                <select class="form-select" id="situacao" name="situacao">
                                    <option value="">---------</option>
                                    <option value="ativo">Ativo</option>
                                    <option value="inativo">Inativo</option>
                                    <option value="suspenso">Suspenso</option>
                                    <option value="aposentado">Aposentado</option>
                                </select>
                                <div class="invalid-feedback" id="situacao-error"></div>
                                <div class="valid-feedback" id="situacao-success"></div>
                            </div>
                        </div>

                        <!-- Observa√ß√µes -->
                        <div class="col-md-6 mb-3">
                            <div class="form-group">
                                <label for="observacoes" class="form-label">
                                    <i class="fas fa-sticky-note me-1"></i>Observa√ß√µes
                                </label>
                                <textarea class="form-control" id="observacoes" name="observacoes" rows="3" placeholder="Observa√ß√µes adicionais"></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- Alertas e Bot√µes de Teste -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="alert alert-info d-flex align-items-center">
                                <i class="fas fa-info-circle me-2"></i>
                                <div>
                                    <strong>Campos obrigat√≥rios</strong> s√£o marcados com asterisco (*)
                                    <button type="button" class="btn btn-warning btn-sm ms-3" onclick="testarValidacao()">
                                        <i class="fas fa-vial me-1"></i>Testar Valida√ß√£o
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Rodap√© do Modal -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="submit" form="advogadoForm" class="btn btn-primary">
                    <i class="fas fa-save me-1"></i>Salvar
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Lista de campos obrigat√≥rios (escopo global)
const requiredFieldNames = [
    'nome', 'cpf', 'oab', 'uf_oab', 'email', 'telefone', 
    'endereco', 'cidade', 'estado', 'cep', 'data_inscricao_oab', 
    'experiencia_anos', 'situacao'
];

// Fun√ß√£o para obter mensagem de erro (escopo global)
function getFieldErrorMessage(fieldName) {
    const errorMessages = {
        'nome': 'Nome √© obrigat√≥rio. Digite o nome completo do advogado.',
        'cpf': 'CPF √© obrigat√≥rio. Digite um CPF v√°lido.',
        'oab': 'OAB √© obrigat√≥ria. Digite o n√∫mero da OAB.',
        'uf_oab': 'UF OAB √© obrigat√≥ria. Selecione o estado da OAB.',
        'email': 'E-mail √© obrigat√≥rio. Digite um endere√ßo de e-mail v√°lido.',
        'telefone': 'Telefone √© obrigat√≥rio. Digite um n√∫mero de telefone v√°lido.',
        'endereco': 'Endere√ßo √© obrigat√≥rio. Digite o endere√ßo completo.',
        'cidade': 'Cidade √© obrigat√≥ria. Digite o nome da cidade.',
        'estado': 'Estado √© obrigat√≥rio. Selecione o estado.',
        'cep': 'CEP √© obrigat√≥rio. Digite um CEP v√°lido.',
        'data_inscricao_oab': 'Data de inscri√ß√£o na OAB √© obrigat√≥ria.',
        'experiencia_anos': 'Anos de experi√™ncia √© obrigat√≥rio.',
        'situacao': 'Situa√ß√£o √© obrigat√≥ria. Selecione uma situa√ß√£o.'
    };
    
    return errorMessages[fieldName] || 'Este campo √© obrigat√≥rio.';
}

// Fun√ß√£o para validar campo individual (escopo global)
function validateField(field) {
    const fieldName = field.name;
    const value = field.value.trim();
    const isEmpty = !value || value === '' || value === '---------';
    
    // Remover classes anteriores
    field.classList.remove('is-valid', 'is-invalid');
    field.closest('.form-group')?.classList.remove('has-success', 'has-error');
    
    // Limpar mensagens anteriores
    const errorDiv = document.getElementById(`${fieldName}-error`);
    const successDiv = document.getElementById(`${fieldName}-success`);
    
    if (errorDiv) errorDiv.textContent = '';
    if (successDiv) successDiv.textContent = '';
    
    if (isEmpty) {
        // Campo inv√°lido
        field.classList.add('is-invalid');
        field.closest('.form-group')?.classList.add('has-error');
        
        if (errorDiv) {
            errorDiv.textContent = getFieldErrorMessage(fieldName);
        }
        
        // Adicionar anima√ß√£o de erro
        field.classList.add('field-error');
        setTimeout(() => field.classList.remove('field-error'), 500);
        
        return false;
    } else {
        // Campo v√°lido
        field.classList.add('is-valid');
        field.closest('.form-group')?.classList.add('has-success');
        
        if (successDiv) {
            successDiv.textContent = '‚úì Campo preenchido corretamente';
        }
        
        return true;
    }
}

// Fun√ß√£o para mostrar resumo dos erros (escopo global)
function showErrorSummary(errorCount, errorFields) {
    console.log(`üìä Mostrando resumo de ${errorCount} erros...`);
    
    const errorSummary = document.getElementById('errorSummary');
    const errorSummaryText = document.getElementById('errorSummaryText');
    
    if (errorSummary && errorSummaryText) {
        errorSummaryText.innerHTML = `
            Foram encontrados <strong>${errorCount}</strong> campo(s) obrigat√≥rio(s) n√£o preenchido(s):<br>
            <strong>${errorFields.join(', ')}</strong><br>
            Por favor, corrija os campos destacados em vermelho e tente novamente.
        `;
        errorSummary.style.display = 'block';
        
        // Scroll para o topo do formul√°rio
        errorSummary.scrollIntoView({ behavior: 'smooth', block: 'start' });
        
        console.log('‚úÖ Resumo de erros exibido');
    }
}

// Fun√ß√£o para limpar resumo de erros (escopo global)
function clearErrorSummary() {
    const errorSummary = document.getElementById('errorSummary');
    if (errorSummary) {
        errorSummary.style.display = 'none';
    }
}

// Fun√ß√£o para testar valida√ß√£o diretamente no modal
function testarValidacao() {
    console.log('üß™ Testando valida√ß√£o diretamente no modal...');
    
    // For√ßar valida√ß√£o de todos os campos
    let errorCount = 0;
    let errorFields = [];
    
    requiredFieldNames.forEach(fieldName => {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (field) {
            // For√ßar valida√ß√£o do campo
            const isValid = validateField(field);
            if (!isValid) {
                errorCount++;
                errorFields.push(fieldName);
            }
        }
    });
    
    if (errorCount > 0) {
        console.log(`‚ùå Foram encontrados ${errorCount} erros de valida√ß√£o`);
        showErrorSummary(errorCount, errorFields);
        
        // Fazer scroll para o primeiro erro
        const firstErrorField = document.querySelector(`[name="${errorFields[0]}"]`);
        if (firstErrorField) {
            firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
            firstErrorField.focus();
        }
    } else {
        console.log('‚úÖ Todos os campos est√£o v√°lidos!');
        clearErrorSummary();
    }
}

// Fun√ß√£o principal de inicializa√ß√£o da valida√ß√£o
function initializeValidation() {
    console.log('üöÄ Inicializando valida√ß√£o do formul√°rio...');
    
    // Verificar se o formul√°rio existe
    const form = document.getElementById('advogadoForm');
    if (!form) {
        console.error('‚ùå CR√çTICO: Formul√°rio advogadoForm n√£o encontrado!');
        return false;
    }
    
    console.log('‚úÖ Formul√°rio encontrado:', form);
    console.log('‚úÖ ID do formul√°rio:', form.id);
    
    console.log(`üîç Lista de campos obrigat√≥rios: ${requiredFieldNames.join(', ')}`);
    
    // Fun√ß√£o para validar formul√°rio antes do envio
    function validateForm(e) {
        console.log('üîç Validando formul√°rio antes do envio...');
        
        // Verificar se h√° campos obrigat√≥rios vazios
        let hasErrors = false;
        let errorCount = 0;
        let errorFields = [];
        
        console.log(`üîç Verificando ${requiredFieldNames.length} campos obrigat√≥rios...`);
        
        requiredFieldNames.forEach(fieldName => {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field) {
                const isValid = validateField(field);
                if (!isValid) {
                    hasErrors = true;
                    errorCount++;
                    errorFields.push(fieldName);
                }
            }
        });
        
        if (hasErrors) {
            e.preventDefault();
            console.log(`‚ùå Formul√°rio bloqueado devido a ${errorCount} erro(s) de valida√ß√£o`);
            console.log(`‚ùå Campos com erro: ${errorFields.join(', ')}`);
            
            // Mostrar resumo dos erros
            showErrorSummary(errorCount, errorFields);
            
            // Fazer scroll para o primeiro erro
            const firstErrorField = document.querySelector(`[name="${errorFields[0]}"]`);
            if (firstErrorField) {
                firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                firstErrorField.focus();
            }
            
            return false;
        }
        
        console.log('‚úÖ Formul√°rio v√°lido, enviando...');
        return true;
    }
    
    // Configurar event listeners
    console.log('üîß Configurando event listeners...');
    
    // Event listener para o formul√°rio
    if (form) {
        console.log('‚úÖ Formul√°rio encontrado, adicionando event listener de submit');
        form.addEventListener('submit', validateForm);
        console.log('‚úÖ Event listener de submit adicionado');
    } else {
        console.error('‚ùå Formul√°rio n√£o encontrado!');
    }
    
    // Event listeners para valida√ß√£o em tempo real
    requiredFieldNames.forEach(fieldName => {
        const field = document.querySelector(`[name="${fieldName}"]`);
        if (field) {
            // Valida√ß√£o ao perder foco
            field.addEventListener('blur', () => {
                validateField(field);
                updateErrorSummary();
            });
            
            // Valida√ß√£o ao digitar (para campos de texto)
            if (field.type === 'text' || field.type === 'email' || field.type === 'number') {
                field.addEventListener('input', () => {
                    if (field.value.trim()) {
                        validateField(field);
                        updateErrorSummary();
                    }
                });
            }
            
            // Valida√ß√£o ao mudar sele√ß√£o (para selects)
            if (field.tagName === 'SELECT') {
                field.addEventListener('change', () => {
                    validateField(field);
                    updateErrorSummary();
                });
            }
        }
    });
    
    // Fun√ß√£o para atualizar resumo de erros
    function updateErrorSummary() {
        const errorFields = [];
        requiredFieldNames.forEach(fieldName => {
            const field = document.querySelector(`[name="${fieldName}"]`);
            if (field && field.classList.contains('is-invalid')) {
                errorFields.push(fieldName);
            }
        });
        
        if (errorFields.length === 0) {
            clearErrorSummary();
        } else {
            showErrorSummary(errorFields.length, errorFields);
        }
    }
    
    console.log('‚úÖ Valida√ß√£o do formul√°rio inicializada com sucesso!');
    console.log('üîç Para testar: deixe campos vazios e clique em salvar');
    
    return true;
}

// Inicializar quando o DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ DOM carregado, tentando inicializar valida√ß√£o...');
    
    // Tentar inicializar imediatamente
    if (!initializeValidation()) {
        // Se n√£o conseguir, tentar novamente ap√≥s um delay
        setTimeout(function() {
            console.log('‚è≥ Tentando novamente ap√≥s delay...');
            initializeValidation();
        }, 500);
        
        // Tentar mais algumas vezes
        setTimeout(function() {
            console.log('‚è≥ Tentativa final...');
            initializeValidation();
        }, 1000);
    }
});

console.log('üöÄ Script de valida√ß√£o carregado, aguardando inicializa√ß√£o...');
</script>
{% endblock %}
