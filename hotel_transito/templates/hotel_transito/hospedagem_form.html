{% extends 'base.html' %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}
    {% if object %}Editar Hospedagem{% else %}Nova Hospedagem{% endif %} - Hotel de Tr√¢nsito
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'hotel_transito/css/modais.css' %}">
<style>
    .page-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 15px;
        padding: 2rem;
        margin-bottom: 2rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
    
    .page-header h1 {
        margin: 0;
        font-size: 2.5rem;
        font-weight: bold;
    }
    
    .page-header p {
        margin: 0.5rem 0 0 0;
        opacity: 0.9;
        font-size: 1.1rem;
    }
    
    .form-container {
        background: white;
        border-radius: 15px;
        padding: 2rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }
    
    .form-section {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #e9ecef;
    }
    
    .form-section:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .section-title {
        color: #495057;
        font-size: 1.25rem;
        font-weight: 600;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #667eea;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    
    .form-row {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-bottom: 1rem;
    }
    
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 0.5rem;
    }
    
    .form-control {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0.75rem;
        font-size: 1rem;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
    }
    
    .form-select {
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23343a40' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m1 6 7 7 7-7'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        background-position: right 0.75rem center;
        background-size: 16px 12px;
    }
    
    .btn-container {
        display: flex;
        gap: 1rem;
        justify-content: flex-end;
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid #e9ecef;
    }
    
    .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .btn-secondary {
        background: #6c757d;
        border: none;
        padding: 0.75rem 2rem;
        border-radius: 8px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .btn-secondary:hover {
        background: #5a6268;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    
    .alert {
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1.5rem;
        border: none;
    }
    
    .alert-info {
        background-color: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
    }
    
    .alert-warning {
        background-color: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
    }
    
    .help-text {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
    
    .required-field::after {
        content: " *";
        color: #dc3545;
        font-weight: bold;
    }
    
    .datetime-input {
        position: relative;
    }
    
    .datetime-input input {
        padding-right: 2.5rem;
    }
    
    .datetime-input::after {
        content: "üìÖ";
        position: absolute;
        right: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        pointer-events: none;
        font-size: 1rem;
    }
    
    .reservation-info {
        background: #f8f9fa;
        border: 1px solid #e9ecef;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
    }
    
    .reservation-info h6 {
        color: #495057;
        margin-bottom: 0.5rem;
        font-weight: 600;
    }
    
    .reservation-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        font-size: 0.9rem;
    }
    
    .detail-item {
        display: flex;
        flex-direction: column;
    }
    
    .detail-label {
        font-weight: 600;
        color: #6c757d;
        font-size: 0.8rem;
        text-transform: uppercase;
        margin-bottom: 0.25rem;
    }
    
    .detail-value {
        color: #495057;
        font-weight: 500;
    }
    
    .quarto-status {
        display: inline-block;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
    }
    
    .status-disponivel {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-ocupado {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .status-reservado {
        background-color: #fff3cd;
        color: #856404;
    }
    
    .status-manutencao {
        background-color: #d1ecf1;
        color: #0c5460;
    }
    
    .field-help {
        font-size: 0.8rem;
        color: #6c757d;
        margin-top: 0.25rem;
        font-style: italic;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Cabe√ßalho da P√°gina -->
    <div class="page-header">
        <h1>
            <i class="fas fa-bed me-3"></i>
            {% if object %}Editar Hospedagem{% else %}Nova Hospedagem{% endif %}
        </h1>
        <p>
            {% if object %}
                Atualize os dados da hospedagem #{{ object.id }}
            {% else %}
                Cadastre uma nova hospedagem no hotel de tr√¢nsito
            {% endif %}
        </p>
    </div>

    <!-- Formul√°rio -->
    <div class="form-container">
        <form method="post" id="hospedagemForm">
            {% csrf_token %}
            
            <!-- Alertas -->
            {% if form.errors %}
            <div class="alert alert-danger">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Erro no Formul√°rio</h6>
                <p>Por favor, corrija os erros abaixo:</p>
                {{ form.non_field_errors }}
            </div>
            {% endif %}
            
            <!-- Informa√ß√µes da Reserva (se existir) -->
            {% if form.reserva.value %}
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-calendar-check"></i>
                    Informa√ß√µes da Reserva
                </h3>
                <div class="reservation-info">
                    <h6>Reserva Selecionada</h6>
                    <div class="reservation-details">
                        <div class="detail-item">
                            <span class="detail-label">C√≥digo</span>
                            <span class="detail-value">{{ form.reserva.value }}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">Status</span>
                            <span class="detail-value">Confirmada</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- Informa√ß√µes da Hospedagem -->
            <div class="form-section">
                <h3><i class="fas fa-bed"></i> Informa√ß√µes da Hospedagem</h3>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.quarto.id_for_label }}">
                            {{ form.quarto.label }}
                            {% if form.quarto.field.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        {{ form.quarto }}
                        {% if form.quarto.help_text %}
                            <div class="help-text">{{ form.quarto.help_text }}</div>
                        {% endif %}
                        {% if form.quarto.errors %}
                            <div class="error-message">{{ form.quarto.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.hospede.id_for_label }}">
                            {{ form.hospede.label }}
                            {% if form.hospede.field.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        {{ form.hospede }}
                        {% if form.hospede.help_text %}
                            <div class="help-text">{{ form.hospede.help_text }}</div>
                        {% endif %}
                        {% if form.hospede.errors %}
                            <div class="error-message">{{ form.hospede.errors.0 }}</div>
                        {% endif %}
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="{{ form.reserva.id_for_label }}">
                            {{ form.reserva.label }}
                            {% if form.reserva.field.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        {{ form.reserva }}
                        {% if form.reserva.help_text %}
                            <div class="help-text">{{ form.reserva.help_text }}</div>
                        {% endif %}
                        {% if form.reserva.errors %}
                            <div class="error-message">{{ form.reserva.errors.0 }}</div>
                        {% endif %}
                    </div>
                    
                    <div class="form-group">
                        <label for="{{ form.valor_diaria_real.id_for_label }}">
                            {{ form.valor_diaria_real.label }}
                            {% if form.valor_diaria_real.field.required %}<span class="text-danger">*</span>{% endif %}
                        </label>
                        {{ form.valor_diaria_real }}
                        {% if form.valor_diaria_real.help_text %}
                            <div class="help-text">{{ form.valor_diaria_real.help_text }}</div>
                        {% endif %}
                        {% if form.valor_diaria_real.errors %}
                            <div class="error-message">{{ form.valor_diaria_real.errors.0 }}</div>
                        {% endif %}
                        <div class="help-text" id="valor-quarto-info" style="display: none;">
                            <i class="fas fa-info-circle"></i> Valor padr√£o do quarto: <span id="valor-padrao"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Informa√ß√µes adicionais -->
        <div class="info-box">
            <h4><i class="fas fa-info-circle"></i> Informa√ß√µes Importantes</h4>
            <p>
                <strong>Reserva:</strong> Selecione uma reserva existente ou deixe em branco para hospedagem direta.<br>
                <strong>Quarto:</strong> Certifique-se de que o quarto esteja dispon√≠vel para o per√≠odo selecionado.<br>
                <strong>Valor da Di√°ria:</strong> Este valor ser√° preenchido automaticamente baseado no quarto selecionado.<br>
                <strong>Datas:</strong> As datas ser√£o preenchidas automaticamente com valores padr√£o.
            </p>
        </div>

        <!-- Campos de data e hora -->
        <div class="form-section">
            <h3><i class="fas fa-calendar-alt"></i> Datas e Hor√°rios</h3>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="{{ form.data_entrada_real.id_for_label }}">
                        {{ form.data_entrada_real.label }}
                        {% if form.data_entrada_real.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    {{ form.data_entrada_real }}
                    {% if form.data_entrada_real.help_text %}
                        <div class="help-text">{{ form.data_entrada_real.help_text }}</div>
                    {% endif %}
                    {% if form.data_entrada_real.errors %}
                        <div class="error-message">{{ form.data_entrada_real.errors.0 }}</div>
                    {% endif %}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.data_saida_real.id_for_label }}">
                        {{ form.data_saida_real.label }}
                        {% if form.data_saida_real.field.required %}<span class="text-danger">*</span>{% endif %}
                    </label>
                    {{ form.data_saida_real }}
                    {% if form.data_saida_real.help_text %}
                        <div class="help-text">{{ form.data_saida_real.help_text }}</div>
                    {% endif %}
                    {% if form.data_saida_real.errors %}
                        <div class="error-message">{{ form.data_saida_real.errors.0 }}</div>
                    {% endif %}
                    <div class="help-text">
                        <i class="fas fa-info-circle"></i> Este campo √© opcional e pode ser preenchido posteriormente.
                    </div>
                </div>
            </div>
        </div>
            
            <!-- Observa√ß√µes -->
            <div class="form-section">
                <h3 class="section-title">
                    <i class="fas fa-sticky-note"></i>
                    Observa√ß√µes
                </h3>
                
                <div class="form-group">
                    <label for="{{ form.observacoes.id_for_label }}">
                        Observa√ß√µes Adicionais
                    </label>
                    {{ form.observacoes }}
                    {% if form.observacoes.help_text %}
                    <div class="help-text">{{ form.observacoes.help_text }}</div>
                    {% endif %}
                    {% if form.observacoes.errors %}
                    <div class="text-danger">{{ form.observacoes.errors }}</div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Bot√µes de A√ß√£o -->
            <div class="btn-container">
                <a href="{% url 'hotel_transito:hospedagem_list' %}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Cancelar
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save me-2"></i>
                    {% if object %}Atualizar{% else %}Criar{% endif %} Hospedagem
                </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Auto-preenchimento do valor da di√°ria baseado no quarto selecionado
    const quartoSelect = document.getElementById('{{ form.quarto.id_for_label }}');
    const valorDiariaInput = document.getElementById('{{ form.valor_diaria_real.id_for_label }}');
    const valorQuartoInfo = document.getElementById('valor-quarto-info');
    const valorPadrao = document.getElementById('valor-padrao');
    
    if (quartoSelect && valorDiariaInput) {
        quartoSelect.addEventListener('change', function() {
            const quartoId = this.value;
            if (quartoId) {
                // Fazer requisi√ß√£o AJAX para obter o valor da di√°ria do quarto
                fetch(`/hotel-transito/ajax/quarto/${quartoId}/info/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.quarto) {
                            valorDiariaInput.value = data.quarto.valor_diaria;
                            valorPadrao.textContent = `R$ ${parseFloat(data.quarto.valor_diaria).toFixed(2)}`;
                            valorQuartoInfo.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao obter informa√ß√µes do quarto:', error);
                        // Fallback: tentar obter o valor do option selecionado
                        const selectedOption = quartoSelect.options[quartoSelect.selectedIndex];
                        if (selectedOption && selectedOption.dataset.valor) {
                            valorDiariaInput.value = selectedOption.dataset.valor;
                        }
                    });
            } else {
                valorQuartoInfo.style.display = 'none';
                valorDiariaInput.value = '';
            }
        });
    }
    
    // Valida√ß√£o de datas
    const dataEntradaInput = document.getElementById('{{ form.data_entrada_real.id_for_label }}');
    const dataSaidaInput = document.getElementById('{{ form.data_saida_real.id_for_label }}');
    
    if (dataEntradaInput && dataSaidaInput) {
        dataEntradaInput.addEventListener('change', validateDates);
        dataSaidaInput.addEventListener('change', validateDates);
        
        function validateDates() {
            const entrada = new Date(dataEntradaInput.value);
            const saida = new Date(dataSaidaInput.value);
            
            // S√≥ validar se ambos os campos estiverem preenchidos
            if (entrada && saida && entrada >= saida) {
                dataSaidaInput.setCustomValidity('A data/hora de sa√≠da deve ser posterior √† data/hora de entrada.');
            } else {
                dataSaidaInput.setCustomValidity('');
            }
        }
    }
    
    // Preenchimento autom√°tico da data de entrada com data atual
    if (dataEntradaInput && !dataEntradaInput.value) {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        
        dataEntradaInput.value = `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    // N√£o preencher automaticamente a data de sa√≠da (campo opcional)
    // O usu√°rio pode preench√™-la quando souber a data de sa√≠da
    
    // Filtro de reservas baseado no h√≥spede selecionado
    const hospedeSelect = document.getElementById('{{ form.hospede.id_for_label }}');
    const reservaSelect = document.getElementById('{{ form.reserva.id_for_label }}');
    
    if (hospedeSelect && reservaSelect) {
        hospedeSelect.addEventListener('change', function() {
            const hospedeId = this.value;
            if (hospedeId) {
                // Filtrar reservas do h√≥spede selecionado
                Array.from(reservaSelect.options).forEach(option => {
                    if (option.value && option.dataset.hospede) {
                        if (option.dataset.hospede === hospedeId) {
                            option.style.display = '';
                        } else {
                            option.style.display = 'none';
                        }
                    }
                });
            }
        });
    }
    
    // Filtro de quartos baseado na reserva selecionada
    if (reservaSelect && quartoSelect) {
        reservaSelect.addEventListener('change', function() {
            const reservaId = this.value;
            if (reservaId) {
                // Obter informa√ß√µes da reserva e preencher automaticamente
                fetch(`/hotel-transito/ajax/reserva/${reservaId}/info/`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.reserva) {
                            // Preencher quarto
                            quartoSelect.value = data.reserva.quarto;
                            // Preencher h√≥spede
                            if (hospedeSelect) {
                                hospedeSelect.value = data.reserva.hospede;
                            }
                            // Preencher valor da di√°ria
                            if (valorDiariaInput) {
                                valorDiariaInput.value = data.reserva.valor_diaria;
                            }
                            // Preencher datas
                            if (dataEntradaInput) {
                                const entrada = new Date(data.reserva.data_entrada + ' ' + data.reserva.hora_entrada);
                                dataEntradaInput.value = entrada.toISOString().slice(0, 16);
                            }
                            if (dataSaidaInput) {
                                const saida = new Date(data.reserva.data_saida + ' ' + data.reserva.hora_saida);
                                dataSaidaInput.value = saida.toISOString().slice(0, 16);
                            }
                            
                            // Disparar evento de mudan√ßa do quarto para atualizar valor
                            quartoSelect.dispatchEvent(new Event('change'));
                        }
                    })
                    .catch(error => {
                        console.error('Erro ao obter informa√ß√µes da reserva:', error);
                    });
            }
        });
    }
});
</script>
{% endblock %}
