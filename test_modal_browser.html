<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste Modal Associado - Navegador</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</head>
<body>
    <div class="container mt-5">
        <h1>Teste do Modal de Associados no Navegador</h1>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Teste do Modal</h5>
                    </div>
                    <div class="card-body">
                        <button type="button" class="btn btn-primary" onclick="testarModal()">
                            Abrir Modal de Teste
                        </button>
                        
                        <button type="button" class="btn btn-success" onclick="testarModalDireto()">
                            Testar Modal Direto
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>Logs</h5>
                    </div>
                    <div class="card-body">
                        <div id="logs" style="height: 300px; overflow-y: auto; background: #f8f9fa; padding: 10px; font-family: monospace; font-size: 12px;">
                            <div>Clique nos bot√µes para testar...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="resultado" class="mt-3"></div>
    </div>

    <script>
        // Fun√ß√£o para adicionar logs
        function addLog(message, type = 'info') {
            const logs = document.getElementById('logs');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `<span style="color: #666;">[${timestamp}]</span> <span style="color: ${type === 'error' ? 'red' : type === 'success' ? 'green' : 'blue'};">${message}</span>`;
            logs.appendChild(logEntry);
            logs.scrollTop = logs.scrollHeight;
        }
        
        // Fun√ß√£o para testar o modal
        function testarModal() {
            addLog('üîç Testando modal de associado...');
            
            // Verificar se a fun√ß√£o existe
            if (typeof openAssociadoModal === 'function') {
                addLog('‚úÖ Fun√ß√£o openAssociadoModal encontrada');
                openAssociadoModal();
            } else {
                addLog('‚ùå Fun√ß√£o openAssociadoModal n√£o encontrada');
                addLog('üîÑ Tentando carregar script...');
                
                // Carregar o script dos modais
                const script = document.createElement('script');
                script.src = '/static/associados/js/modais.js';
                script.onload = function() {
                    addLog('‚úÖ Script carregado com sucesso');
                    if (typeof openAssociadoModal === 'function') {
                        addLog('‚úÖ Fun√ß√£o dispon√≠vel ap√≥s carregar script');
                        openAssociadoModal();
                    } else {
                        addLog('‚ùå Fun√ß√£o ainda n√£o dispon√≠vel');
                    }
                };
                script.onerror = function() {
                    addLog('‚ùå Erro ao carregar script');
                };
                document.head.appendChild(script);
            }
        }
        
        // Fun√ß√£o para testar modal direto
        function testarModalDireto() {
            addLog('üîç Testando modal direto...');
            
            // Testar a chamada da API diretamente
            fetch('/associados/associados/modal/novo/')
                .then(response => {
                    addLog(`üì° Resposta: ${response.status} ${response.statusText}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return response.json();
                })
                .then(data => {
                    addLog('‚úÖ Dados recebidos com sucesso');
                    addLog(`üìã Form HTML: ${data.form_html ? data.form_html.length + ' caracteres' : 'n√£o encontrado'}`);
                    
                    if (data.form_html) {
                        // Criar modal manualmente
                        criarModalManual('Novo Associado', data.form_html);
                    } else {
                        addLog('‚ùå Form HTML n√£o encontrado');
                    }
                })
                .catch(error => {
                    addLog(`‚ùå Erro na API: ${error.message}`, 'error');
                });
        }
        
        // Fun√ß√£o para criar modal manualmente
        function criarModalManual(title, formHtml) {
            addLog('üîß Criando modal manual...');
            
            // Remover modais existentes
            const existingModals = document.querySelectorAll('[id^="manualModal_"]');
            existingModals.forEach(modal => modal.remove());
            
            const modalId = 'manualModal_' + Date.now();
            const modalHtml = `
                <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="${modalId}Label" aria-hidden="true">
                    <div class="modal-dialog modal-xl modal-dialog-scrollable">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="${modalId}Label">${title}</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                            </div>
                            <div class="modal-body">
                                ${formHtml}
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" form="associadoForm" class="btn btn-primary">Salvar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Inserir no body
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Criar e mostrar modal
            const modalElement = document.getElementById(modalId);
            if (modalElement && typeof bootstrap !== 'undefined' && typeof bootstrap.Modal !== 'undefined') {
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
                
                // Configurar envio do formul√°rio
                const form = document.getElementById('associadoForm');
                if (form) {
                    addLog('üîß Configurando envio do formul√°rio...');
                    form.addEventListener('submit', (e) => {
                        e.preventDefault();
                        addLog('üì§ Formul√°rio enviado');
                        
                        // Coletar dados do formul√°rio
                        const formData = new FormData(form);
                        
                        // Enviar dados
                        fetch('/associados/associados/modal/novo/', {
                            method: 'POST',
                            body: formData
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                addLog(`‚úÖ Sucesso: ${data.message}`, 'success');
                                modal.hide();
                                if (data.reload) {
                                    location.reload();
                                }
                            } else {
                                addLog(`‚ùå Erro: ${data.message}`, 'error');
                                if (data.errors) {
                                    addLog(`‚ùå Erros: ${JSON.stringify(data.errors)}`, 'error');
                                }
                            }
                        })
                        .catch(error => {
                            addLog(`‚ùå Erro ao enviar: ${error.message}`, 'error');
                        });
                    });
                }
                
                addLog('‚úÖ Modal criado e exibido com sucesso');
                return modal;
            } else {
                addLog('‚ùå Bootstrap n√£o dispon√≠vel', 'error');
            }
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            addLog('üöÄ P√°gina carregada');
            addLog('üìã Verificando fun√ß√µes dispon√≠veis...');
            
            if (typeof openAssociadoModal === 'function') {
                addLog('‚úÖ openAssociadoModal dispon√≠vel');
            } else {
                addLog('‚ùå openAssociadoModal n√£o dispon√≠vel');
            }
            
            if (typeof bootstrap !== 'undefined') {
                addLog('‚úÖ Bootstrap dispon√≠vel');
            } else {
                addLog('‚ùå Bootstrap n√£o dispon√≠vel');
            }
        });
    </script>
</body>
</html>
