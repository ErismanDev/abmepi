<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste dos Modais - Psicólogos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="psicologia/static/psicologia/css/modais.css">
</head>
<body>
    <div class="container mt-5">
        <h1>Teste dos Modais - Psicólogos</h1>
        
        <div class="row mt-4">
            <div class="col-md-6">
                <button type="button" class="btn btn-primary btn-lg" onclick="testarModalNovo()">
                    <i class="fas fa-plus"></i> Testar Modal Novo Psicólogo
                </button>
            </div>
            <div class="col-md-6">
                <button type="button" class="btn btn-warning btn-lg" onclick="testarModalEditar()">
                    <i class="fas fa-edit"></i> Testar Modal Editar Psicólogo
                </button>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <h5>Instruções:</h5>
                    <ol>
                        <li>Clique em "Testar Modal Novo Psicólogo" para testar a criação</li>
                        <li>Clique em "Testar Modal Editar Psicólogo" para testar a edição</li>
                        <li>Verifique o console do navegador para mensagens de debug</li>
                    </ol>
                </div>
            </div>
        </div>
        
        <div class="row mt-4">
            <div class="col-12">
                <h4>Status das Funções:</h4>
                <div id="status-funcoes"></div>
            </div>
        </div>
    </div>

    <!-- Sistema de Modais Base -->
    <div id="modalContainer"></div>

    <!-- Script para gerenciar modais -->
    <script>
        // Sistema de Modais
        class ModalManager {
            constructor() {
                this.modalContainer = document.getElementById('modalContainer');
                this.currentModal = null;
            }

            // Criar modal de formulário
            createFormModal(title, formHtml, formId, submitUrl, method = 'POST', csrfToken = null) {
                const modalId = 'formModal_' + Date.now();
                const modalHtml = `
                    <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="${modalId}Label" aria-hidden="true">
                        <div class="modal-dialog modal-lg modal-dialog-scrollable">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="${modalId}Label">${title}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    ${formHtml}
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="submit" form="${formId}" class="btn btn-primary">Salvar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                this.modalContainer.innerHTML = modalHtml;
                const modal = new bootstrap.Modal(document.getElementById(modalId));
                
                // Configurar envio do formulário
                const form = document.getElementById(formId);
                if (form) {
                    form.addEventListener('submit', (e) => this.handleFormSubmit(e, submitUrl, method, csrfToken, modal));
                }

                this.currentModal = modal;
                return modal;
            }

            // Criar modal de confirmação
            createConfirmModal(title, message, confirmCallback, cancelCallback) {
                const modalId = 'confirmModal_' + Date.now();
                const modalHtml = `
                    <div class="modal fade" id="${modalId}" tabindex="-1" aria-labelledby="${modalId}Label" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="${modalId}Label">${title}</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <p>${message}</p>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <button type="button" class="btn btn-primary" id="btnConfirmar">Confirmar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                this.modalContainer.innerHTML = modalHtml;
                const modal = new bootstrap.Modal(document.getElementById(modalId));
                
                // Configurar botões
                document.getElementById('btnConfirmar').addEventListener('click', () => {
                    if (confirmCallback) confirmCallback();
                    modal.hide();
                });

                modal._element.addEventListener('hidden.bs.modal', () => {
                    if (cancelCallback) cancelCallback();
                });

                this.currentModal = modal;
                return modal;
            }

            show(modal) {
                if (modal) {
                    modal.show();
                }
            }

            hide(modal) {
                if (modal) {
                    modal.hide();
                }
            }

            hideCurrent() {
                if (this.currentModal) {
                    this.currentModal.hide();
                }
            }

            clear() {
                this.modalContainer.innerHTML = '';
                this.currentModal = null;
            }

            handleFormSubmit(event, submitUrl, method, csrfToken, modal) {
                event.preventDefault();
                console.log('Enviando formulário para:', submitUrl);
                
                const form = event.target;
                const formData = new FormData(form);
                
                // Adicionar CSRF token se fornecido
                if (csrfToken) {
                    formData.append('csrfmiddlewaretoken', csrfToken);
                }

                fetch(submitUrl, {
                    method: method,
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    console.log('Resposta recebida:', data);
                    
                    if (data.success) {
                        alert('Sucesso: ' + data.message);
                        modal.hide();
                        // Recarregar página se solicitado
                        if (data.reload) {
                            location.reload();
                        }
                    } else {
                        alert('Erro: ' + data.message);
                        // Mostrar erros de validação se houver
                        if (data.errors) {
                            console.log('Erros de validação:', data.errors);
                        }
                    }
                })
                .catch(error => {
                    console.error('Erro ao enviar formulário:', error);
                    alert('Erro ao enviar formulário. Verifique o console.');
                });
            }

            getCsrfToken() {
                return document.querySelector('[name=csrfmiddlewaretoken]')?.value;
            }

            showMessage(type, message) {
                const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
                const alertDiv = document.createElement('div');
                alertDiv.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
                alertDiv.style.top = '20px';
                alertDiv.style.right = '20px';
                alertDiv.style.zIndex = '9999';
                alertDiv.innerHTML = `
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                document.body.appendChild(alertDiv);
                
                setTimeout(() => {
                    if (alertDiv.parentNode) {
                        alertDiv.remove();
                    }
                }, 5000);
            }

            displayFormErrors(errors) {
                // Limpar erros anteriores
                document.querySelectorAll('.is-invalid').forEach(field => {
                    field.classList.remove('is-invalid');
                });
                document.querySelectorAll('.invalid-feedback').forEach(feedback => {
                    feedback.remove();
                });

                // Mostrar novos erros
                Object.keys(errors).forEach(fieldName => {
                    const field = document.querySelector(`[name="${fieldName}"]`);
                    if (field) {
                        field.classList.add('is-invalid');
                        
                        const feedback = document.createElement('div');
                        feedback.className = 'invalid-feedback';
                        feedback.textContent = errors[fieldName][0];
                        
                        field.parentNode.appendChild(feedback);
                    }
                });
            }
        }

        // Instanciar gerenciador de modais globalmente
        window.modalManager = new ModalManager();

        // Função global para abrir modais de formulário
        window.openFormModal = function(title, formHtml, formId, submitUrl, method = 'POST') {
            const modal = window.modalManager.createFormModal(title, formHtml, formId, submitUrl, method);
            window.modalManager.show(modal);
            return modal;
        };

        // Função global para abrir modais de confirmação
        window.openConfirmModal = function(title, message, confirmCallback, cancelCallback) {
            const modal = window.modalManager.createConfirmModal(title, message, confirmCallback, cancelCallback);
            window.modalManager.show(modal);
            return modal;
        };

        // Funções para testar os modais
        function testarModalNovo() {
            console.log('Testando modal novo psicólogo...');
            
            // Simular formulário HTML
            const formHtml = `
                <form id="psicologoForm" method="post" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nome_completo" class="form-label">Nome Completo *</label>
                                <input type="text" class="form-control" name="nome_completo" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="crp" class="form-label">CRP *</label>
                                <input type="text" class="form-control" name="crp" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" class="form-control" name="email" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="tel" class="form-control" name="telefone">
                            </div>
                        </div>
                    </div>
                </form>
            `;
            
            openFormModal(
                'Novo Psicólogo - TESTE',
                formHtml,
                'psicologoForm',
                '/teste/novo/'
            );
        }

        function testarModalEditar() {
            console.log('Testando modal editar psicólogo...');
            
            // Simular formulário HTML preenchido
            const formHtml = `
                <form id="psicologoForm" method="post" enctype="multipart/form-data">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="nome_completo" class="form-label">Nome Completo *</label>
                                <input type="text" class="form-control" name="nome_completo" value="Dr. João Silva" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="crp" class="form-label">CRP *</label>
                                <input type="text" class="form-control" name="crp" value="12345/SP" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="email" class="form-label">Email *</label>
                                <input type="email" class="form-control" name="email" value="joao@exemplo.com" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="telefone" class="form-label">Telefone</label>
                                <input type="tel" class="form-control" name="telefone" value="(11) 99999-9999">
                            </div>
                        </div>
                    </div>
                </form>
            `;
            
            openFormModal(
                'Editar Psicólogo - TESTE',
                formHtml,
                'psicologoForm',
                '/teste/editar/'
            );
        }

        // Verificar status das funções quando a página carregar
        document.addEventListener('DOMContentLoaded', function() {
            const statusDiv = document.getElementById('status-funcoes');
            
            const funcoes = [
                'openFormModal',
                'openConfirmModal',
                'modalManager',
                'testarModalNovo',
                'testarModalEditar'
            ];
            
            let statusHtml = '<div class="row">';
            
            funcoes.forEach(funcao => {
                const existe = typeof window[funcao] !== 'undefined';
                const statusClass = existe ? 'text-success' : 'text-danger';
                const statusIcon = existe ? '✅' : '❌';
                
                statusHtml += `
                    <div class="col-md-6 mb-2">
                        <span class="${statusClass}">
                            ${statusIcon} ${funcao}: ${existe ? 'Disponível' : 'Não encontrada'}
                        </span>
                    </div>
                `;
            });
            
            statusHtml += '</div>';
            statusDiv.innerHTML = statusHtml;
            
            console.log('=== STATUS DAS FUNÇÕES ===');
            funcoes.forEach(funcao => {
                console.log(`${funcao}:`, typeof window[funcao]);
            });
        });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://kit.fontawesome.com/your-fontawesome-kit.js"></script>
</body>
</html>
