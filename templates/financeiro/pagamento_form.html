{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}Registrar Pagamento - ABMEPI{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Cabeçalho da página -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-dollar-sign me-2"></i>
                        Registrar Pagamento
                    </h1>
                    <p class="text-muted mb-0">
                        Registre o pagamento de um recebível ou outro recebimento
                    </p>
                </div>
                <div>
                    <a href="{% url 'financeiro:mensalidade_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>
                        Voltar às Mensalidades
                    </a>
                </div>
            </div>

            <!-- Formulário de Pagamento -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-edit me-2"></i>
                        Dados do Pagamento
                    </h6>
                </div>
                <div class="card-body">
                    <form method="post" novalidate>
                        {% csrf_token %}
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.mensalidade|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.valor_pago.id_for_label }}" class="form-label">
                                    {{ form.valor_pago.label }} <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text">R$</span>
                                    {{ form.valor_pago }}
                                    <span class="input-group-text">BRL</span>
                                </div>
                                {% if form.valor_pago.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.valor_pago.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">Digite o valor pago em reais</small>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.data_pagamento|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.forma_pagamento|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                {{ form.comprovante|as_crispy_field }}
                            </div>
                            <div class="col-md-6 mb-3">
                                {{ form.observacoes|as_crispy_field }}
                            </div>
                        </div>
                        
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                            <a href="{% url 'financeiro:mensalidade_list' %}" class="btn btn-secondary me-md-2">
                                <i class="fas fa-times me-1"></i>
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>
                                Registrar Pagamento
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Painel lateral com informações -->
        <div class="col-lg-4">
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-info-circle me-2"></i>
                        Informações da Mensalidade
                    </h6>
                </div>
                <div class="card-body">
                    <div id="mensalidade-info">
                        <p class="text-muted">Selecione uma mensalidade para ver as informações</p>
                    </div>
                </div>
            </div>
            
            <div class="card shadow mb-4">
                <div class="card-header py-3">
                    <h6 class="m-0 font-weight-bold text-primary">
                        <i class="fas fa-calculator me-2"></i>
                        Cálculos
                    </h6>
                </div>
                <div class="card-body">
                    <div id="calculos-info">
                        <p class="text-muted">Os cálculos serão exibidos aqui</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
$(document).ready(function() {
    // Função para atualizar informações da mensalidade
    function atualizarInfoMensalidade() {
        var mensalidadeId = $('#id_mensalidade').val();
        if (mensalidadeId) {
            $.ajax({
                url: '/financeiro/api/mensalidade/' + mensalidadeId + '/',
                method: 'GET',
                success: function(data) {
                    var infoHtml = `
                        <div class="mb-3">
                            <strong>Associado:</strong><br>
                            <span class="text-primary">${data.associado_nome}</span>
                        </div>
                        <div class="mb-3">
                            <strong>Tipo:</strong><br>
                            <span class="badge bg-primary">${data.tipo_nome}</span>
                        </div>
                        <div class="mb-3">
                            <strong>Valor Original:</strong><br>
                            <span class="text-success">R$ ${data.valor}</span>
                        </div>
                        <div class="mb-3">
                            <strong>Vencimento:</strong><br>
                            <span class="text-info">${data.data_vencimento}</span>
                        </div>
                        <div class="mb-3">
                            <strong>Status:</strong><br>
                            <span class="badge bg-${data.status === 'pendente' ? 'warning' : 'success'}">${data.status_display}</span>
                        </div>
                    `;
                    $('#mensalidade-info').html(infoHtml);
                    
                    // Atualizar valor a pagar
                    $('#id_valor_pago').val(data.valor);
                    
                    // Calcular multas e juros se estiver atrasado
                    if (data.status === 'pendente' && data.dias_atraso > 0) {
                        var multa = parseFloat(data.valor) * 0.02;
                        var juros = parseFloat(data.valor) * 0.001 * data.dias_atraso;
                        var total = parseFloat(data.valor) + multa + juros;
                        
                        var calculosHtml = `
                            <div class="alert alert-warning">
                                <strong>Mensalidade Atrasada!</strong><br>
                                <small>${data.dias_atraso} dia(s) de atraso</small>
                            </div>
                            <div class="mb-2">
                                <strong>Valor Original:</strong> R$ ${data.valor}
                            </div>
                            <div class="mb-2">
                                <strong>Multa (2%):</strong> R$ ${multa.toFixed(2)}
                            </div>
                            <div class="mb-2">
                                <strong>Juros (0.1%/dia):</strong> R$ ${juros.toFixed(2)}
                            </div>
                            <hr>
                            <div class="mb-2">
                                <strong>Total a Pagar:</strong><br>
                                <span class="text-danger fw-bold">R$ ${total.toFixed(2)}</span>
                            </div>
                        `;
                        $('#calculos-info').html(calculosHtml);
                        
                        // Atualizar valor a pagar com multas
                        $('#id_valor_pago').val(total.toFixed(2));
                    } else {
                        $('#calculos-info').html(`
                            <div class="text-success">
                                <i class="fas fa-check-circle me-2"></i>
                                Mensalidade em dia
                            </div>
                        `);
                    }
                },
                error: function() {
                    $('#mensalidade-info').html('<p class="text-danger">Erro ao carregar informações</p>');
                    $('#calculos-info').html('<p class="text-muted">Erro nos cálculos</p>');
                }
            });
        } else {
            $('#mensalidade-info').html('<p class="text-muted">Selecione uma mensalidade para ver as informações</p>');
            $('#calculos-info').html('<p class="text-muted">Os cálculos serão exibidos aqui</p>');
        }
    }
    
    // Atualizar quando a mensalidade for alterada
    $('#id_mensalidade').change(atualizarInfoMensalidade);
    
    // Atualizar se já houver uma mensalidade pré-selecionada
    if ($('#id_mensalidade').val()) {
        atualizarInfoMensalidade();
    }
    
    // Definir data atual como padrão
    var hoje = new Date().toISOString().split('T')[0];
    $('#id_data_pagamento').val(hoje);
    
    // Formatação de moeda brasileira para o campo valor_pago
    const valorPagoInput = document.getElementById('{{ form.valor_pago.id_for_label }}');
    if (valorPagoInput) {
        // Formatação ao digitar
        valorPagoInput.addEventListener('input', function() {
            var value = this.value;
            
            // Permitir números, ponto (separador de milhares), vírgula (separador decimal)
            value = value.replace(/[^\d.,]/g, '');
            
            // Processar o valor para permitir formato brasileiro (1.000,00)
            if (value.indexOf(',') !== -1) {
                // Tem vírgula decimal
                var parts = value.split(',');
                var integerPart = parts[0];
                var decimalPart = parts[1] || '';
                
                // Remover pontos da parte inteira (são separadores de milhares)
                integerPart = integerPart.replace(/\./g, '');
                
                // Limitar casas decimais a 2
                if (decimalPart.length > 2) {
                    decimalPart = decimalPart.substring(0, 2);
                }
                
                // Reconstruir o valor
                value = integerPart + ',' + decimalPart;
            } else if (value.indexOf('.') !== -1) {
                // Tem ponto, verificar se é separador decimal ou de milhares
                var lastDotIndex = value.lastIndexOf('.');
                var beforeLastDot = value.substring(0, lastDotIndex);
                var afterLastDot = value.substring(lastDotIndex + 1);
                
                // Se após o último ponto tem 1 ou 2 dígitos, é separador decimal
                if (afterLastDot.length <= 2 && /^\d{1,2}$/.test(afterLastDot)) {
                    // É separador decimal, converter para vírgula
                    value = beforeLastDot.replace(/\./g, '') + ',' + afterLastDot;
                } else {
                    // É separador de milhares, manter
                    value = value;
                }
            }
            
            this.value = value;
        });
        
        // Formatação ao perder o foco
        valorPagoInput.addEventListener('blur', function() {
            var value = this.value;
            var valueForCalc = value.replace(',', '.');
            var numValue = parseFloat(valueForCalc);
            
            if (!isNaN(numValue) && numValue > 0) {
                // Formatar como moeda brasileira com separadores de milhares
                var formattedValue = numValue.toFixed(2);
                var parts = formattedValue.split('.');
                var integerPart = parts[0];
                var decimalPart = parts[1];
                
                // Adicionar separadores de milhares
                integerPart = integerPart.replace(/\B(?=(\d{3})+(?!\d))/g, '.');
                
                // Formato final: 1.000,00
                this.value = integerPart + ',' + decimalPart;
            }
        });
    }
});
</script>
{% endblock %}
