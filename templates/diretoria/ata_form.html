{% extends 'base.html' %}
{% load static %}

{% block title %}
    {% if ata %}Editar{% else %}Nova{% endif %} Ata de Reunião - ABMEPI
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'tinymce/css/prism.css' %}">
<style>
    .tox-tinymce {
        border: 1px solid #ced4da !important;
        border-radius: 0.375rem !important;
    }
    .tox .tox-editor-header {
        border-bottom: 1px solid #dee2e6 !important;
    }
    .tox .tox-toolbar__primary {
        background: #f8f9fa !important;
    }
    .tox .tox-edit-area__iframe {
        background: white !important;
    }
    .editor-container {
        margin-bottom: 1rem;
    }
    .editor-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: block;
    }
    .editor-help {
        font-size: 0.875rem;
        color: #6c757d;
        margin-top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Cabeçalho da página -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-file-alt me-2"></i>
                        {% if ata %}Editar{% else %}Nova{% endif %} Ata de Reunião
                    </h1>
                    <p class="text-muted mb-0">
                        {% if ata %}
                            Editando: <strong>{{ ata.titulo }}</strong>
                        {% else %}
                            Crie uma nova ata de reunião da diretoria
                        {% endif %}
                    </p>
                </div>
                <div>
                    <a href="{% url 'diretoria:ata_list' %}" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar à Lista
                    </a>
                </div>
            </div>

            <!-- Card do formulário -->
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-info-circle me-2"></i>
                        Dados da Ata
                    </h5>
                </div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}
                        
                        <div class="row">
                            <!-- Título -->
                            <div class="col-md-8 mb-3">
                                <label for="{{ form.titulo.id_for_label }}" class="form-label">
                                    <i class="fas fa-heading me-1"></i>
                                    Título da Ata <span class="text-danger">*</span>
                                </label>
                                {{ form.titulo }}
                                {% if form.titulo.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.titulo.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Tipo de Reunião -->
                            <div class="col-md-4 mb-3">
                                <label for="{{ form.tipo_reuniao.id_for_label }}" class="form-label">
                                    <i class="fas fa-calendar-check me-1"></i>
                                    Tipo de Reunião <span class="text-danger">*</span>
                                </label>
                                {{ form.tipo_reuniao }}
                                {% if form.tipo_reuniao.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.tipo_reuniao.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <!-- Data da Reunião -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.data_reuniao.id_for_label }}" class="form-label">
                                    <i class="fas fa-calendar me-1"></i>
                                    Data e Hora da Reunião <span class="text-danger">*</span>
                                </label>
                                {{ form.data_reuniao }}
                                {% if form.data_reuniao.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.data_reuniao.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Local -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.local.id_for_label }}" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>
                                    Local da Reunião <span class="text-danger">*</span>
                                </label>
                                {{ form.local }}
                                {% if form.local.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.local.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <div class="row">
                            <!-- Presidente -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.presidente.id_for_label }}" class="form-label">
                                    <i class="fas fa-user-tie me-1"></i>
                                    Presidente <span class="text-danger">*</span>
                                </label>
                                {{ form.presidente }}
                                {% if form.presidente.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.presidente.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>

                            <!-- Secretário -->
                            <div class="col-md-6 mb-3">
                                <label for="{{ form.secretario.id_for_label }}" class="form-label">
                                    <i class="fas fa-user-edit me-1"></i>
                                    Secretário <span class="text-danger">*</span>
                                </label>
                                {{ form.secretario }}
                                {% if form.secretario.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.secretario.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Membros Presentes -->
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-users me-1"></i>
                                    Membros Presentes <span class="text-danger">*</span>
                                </label>
                                <div class="row">
                                    {% for choice in form.membros_presentes %}
                                        <div class="col-md-4 col-lg-3">
                                            <div class="form-check">
                                                {{ choice.tag }}
                                                <label class="form-check-label" for="{{ choice.id_for_label }}">
                                                    {{ choice.choice_label }}
                                                </label>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                {% if form.membros_presentes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.membros_presentes.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Membros Ausentes -->
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-user-times me-1"></i>
                                    Membros Ausentes
                                </label>
                                <div class="row">
                                    {% for choice in form.membros_ausentes %}
                                        <div class="col-md-4 col-lg-3">
                                            <div class="form-check">
                                                {{ choice.tag }}
                                                <label class="form-check-label" for="{{ choice.id_for_label }}">
                                                    {{ choice.choice_label }}
                                                </label>
                                            </div>
                                        </div>
                                    {% endfor %}
                                </div>
                                {% if form.membros_ausentes.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.membros_ausentes.errors.0 }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>

                        <!-- Pauta -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="editor-container">
                                    <label for="{{ form.pauta.id_for_label }}" class="editor-label">
                                        <i class="fas fa-list me-1"></i>
                                        Pauta da Reunião
                                    </label>
                                    {{ form.pauta }}
                                    {% if form.pauta.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.pauta.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="editor-help">
                                        Lista dos assuntos a serem tratados na reunião. Use o editor para formatar o texto.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Deliberações -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="editor-container">
                                    <label for="{{ form.deliberacoes.id_for_label }}" class="editor-label">
                                        <i class="fas fa-gavel me-1"></i>
                                        Deliberações <span class="text-danger">*</span>
                                    </label>
                                    {{ form.deliberacoes }}
                                    {% if form.deliberacoes.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.deliberacoes.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="editor-help">
                                        Decisões tomadas na reunião. Use o editor para formatar o texto com listas, negrito, etc.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Observações -->
                        <div class="row">
                            <div class="col-12 mb-4">
                                <div class="editor-container">
                                    <label for="{{ form.observacoes.id_for_label }}" class="editor-label">
                                        <i class="fas fa-sticky-note me-1"></i>
                                        Observações
                                    </label>
                                    {{ form.observacoes }}
                                    {% if form.observacoes.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.observacoes.errors.0 }}
                                        </div>
                                    {% endif %}
                                    <small class="editor-help">
                                        Observações adicionais sobre a reunião. Use o editor para formatar o texto.
                                    </small>
                                </div>
                            </div>
                        </div>

                        <!-- Arquivo da Ata -->
                        <div class="row">
                            <div class="col-12 mb-3">
                                <label for="{{ form.arquivo_ata.id_for_label }}" class="form-label">
                                    <i class="fas fa-file-pdf me-1"></i>
                                    Arquivo da Ata
                                </label>
                                {{ form.arquivo_ata }}
                                {% if form.arquivo_ata.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.arquivo_ata.errors.0 }}
                                    </div>
                                {% endif %}
                                <small class="form-text text-muted">
                                    Faça upload do arquivo PDF da ata (opcional)
                                </small>
                            </div>
                        </div>

                        <!-- Botões de ação -->
                        <div class="d-flex justify-content-between">
                            <div>
                                <a href="{% url 'diretoria:ata_list' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-2"></i>
                                    Cancelar
                                </a>
                            </div>
                            <div>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-2"></i>
                                    {% if ata %}Atualizar Ata{% else %}Criar Ata{% endif %}
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
{{ form.media }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Adicionar classes Bootstrap aos campos do formulário
    const formFields = document.querySelectorAll('input, select, textarea');
    formFields.forEach(field => {
        if (field.type !== 'checkbox' && field.type !== 'file') {
            field.classList.add('form-control');
        } else if (field.type === 'file') {
            field.classList.add('form-control');
        }
    });

    // Adicionar classe aos selects
    const selects = document.querySelectorAll('select');
    selects.forEach(select => {
        select.classList.add('form-select');
    });

    // Adicionar classe aos checkboxes
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        checkbox.classList.add('form-check-input');
    });

    // Configurar TinyMCE após carregamento
    if (typeof tinymce !== 'undefined') {
        tinymce.init({
            selector: 'textarea[id*="pauta"], textarea[id*="deliberacoes"], textarea[id*="observacoes"]',
            height: 300,
            menubar: false,
            plugins: [
                'advlist', 'autolink', 'lists', 'link', 'charmap', 'preview',
                'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                'insertdatetime', 'media', 'table', 'help', 'wordcount', 'emoticons',
                'template', 'codesample', 'hr', 'pagebreak', 'nonbreaking', 'toc'
            ],
            toolbar: 'undo redo | blocks | ' +
                     'bold italic backcolor | alignleft aligncenter ' +
                     'alignright alignjustify | bullist numlist outdent indent | ' +
                     'removeformat | help | table | link | code | fullscreen | ' +
                     'emoticons | template | codesample | hr | pagebreak | toc',
            content_style: 'body { font-family: -apple-system, BlinkMacSystemFont, San Francisco, Segoe UI, Roboto, Helvetica Neue, sans-serif; font-size: 14px; }',
            toolbar_mode: 'sliding',
            contextmenu: 'formats | link',
            branding: false,
            resize: 'both',
            statusbar: true,
            elementpath: true,
            paste_data_images: true,
            paste_as_text: false,
            paste_auto_cleanup_on_paste: true,
            paste_remove_styles: true,
            paste_remove_styles_if_webkit: true,
            paste_merge_formats: true,
            paste_convert_word_fake_lists: true,
            paste_enable_default_filters: true,
            templates: [
                {
                    'title': 'Ata de Reunião - Estrutura Básica',
                    'description': 'Template básico para atas de reunião',
                    'content': `
                        <h2>ATA DE REUNIÃO</h2>
                        <p><strong>Tipo:</strong> [Tipo da Reunião]</p>
                        <p><strong>Data:</strong> [Data e Hora]</p>
                        <p><strong>Local:</strong> [Local da Reunião]</p>
                        <p><strong>Presidente:</strong> [Nome do Presidente]</p>
                        <p><strong>Secretário:</strong> [Nome do Secretário]</p>
                        
                        <h3>PRESENTES:</h3>
                        <ul>
                            <li>[Lista de membros presentes]</li>
                        </ul>
                        
                        <h3>AUSENTES:</h3>
                        <ul>
                            <li>[Lista de membros ausentes]</li>
                        </ul>
                        
                        <h3>PAUTA:</h3>
                        <ol>
                            <li>[Item 1]</li>
                            <li>[Item 2]</li>
                            <li>[Item 3]</li>
                        </ol>
                        
                        <h3>DELIBERAÇÕES:</h3>
                        <p>[Decisões tomadas na reunião]</p>
                        
                        <h3>OBSERVAÇÕES:</h3>
                        <p>[Observações adicionais]</p>
                        
                        <p><em>Esta ata foi aprovada pelos presentes.</em></p>
                    `
                }
            ],
            setup: function (editor) {
                editor.on('change', function () {
                    editor.save();
                });
            }
        });
    }

    // Validação do formulário
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            let isValid = true;
            
            // Salvar conteúdo dos editores TinyMCE antes da validação
            if (typeof tinymce !== 'undefined') {
                tinymce.triggerSave();
            }
            
            // Validar campos obrigatórios
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                } else {
                    field.classList.remove('is-invalid');
                }
            });

            // Validar pelo menos um membro presente
            const membrosPresentes = form.querySelectorAll('input[name="membros_presentes"]:checked');
            if (membrosPresentes.length === 0) {
                const membrosPresentesContainer = form.querySelector('input[name="membros_presentes"]').closest('.col-12');
                if (membrosPresentesContainer) {
                    let errorDiv = membrosPresentesContainer.querySelector('.invalid-feedback');
                    if (!errorDiv) {
                        errorDiv = document.createElement('div');
                        errorDiv.className = 'invalid-feedback d-block';
                        errorDiv.textContent = 'Selecione pelo menos um membro presente.';
                        membrosPresentesContainer.appendChild(errorDiv);
                    }
                }
                isValid = false;
            }

            if (!isValid) {
                e.preventDefault();
                // Scroll para o primeiro campo com erro
                const firstError = form.querySelector('.is-invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
    }
});
</script>
{% endblock %}