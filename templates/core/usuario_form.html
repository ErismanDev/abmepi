{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}
    {% if form.instance.pk %}
        Editar Usu√°rio - ABMEPI
    {% else %}
        Novo Usu√°rio - ABMEPI
    {% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .suggestion-item {
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .suggestion-item:hover {
        background-color: #f8f9fa;
    }
    
    .suggestion-item:last-child {
        border-bottom: none !important;
    }
    
    #cpf-suggestions {
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        border: 1px solid #dee2e6;
    }
    
    .cursor-pointer {
        cursor: pointer;
    }
    
    /* Estilos para cadastros dispon√≠veis */
    .cadastro-item {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
    }
    
    .cadastro-item:hover {
        background-color: #f8f9fa;
        border-color: #dee2e6;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    
    .cadastro-item.active {
        background-color: #d1ecf1;
        border-color: #17a2b8;
        box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
    }
    
    .cadastro-item .badge {
        font-size: 0.75em;
    }
    
    /* Estilo para mensagens de sucesso */
    .alert-success {
        border-left: 4px solid #28a745;
        animation: slideInDown 0.5s ease-out;
    }
    
    @keyframes slideInDown {
        from {
            transform: translateY(-100%);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-user-edit me-2"></i>
        {% if form.instance.pk %}
            Editar Usu√°rio
        {% else %}
            Novo Usu√°rio
        {% endif %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'core:usuario_list' %}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                Voltar √† Lista
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-8">
        <form method="post" novalidate>
            {% csrf_token %}
            
            <!-- Se√ß√£o: Informa√ß√µes B√°sicas -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>
                        Informa√ß√µes B√°sicas
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% if form.username %}
                        <div class="col-md-6">
                            <label for="{{ form.username.id_for_label }}" class="form-label">
                                {{ form.username.label }} <span class="text-danger">*</span>
                            </label>
                            <div class="position-relative">
                                <input type="text" 
                                       name="{{ form.username.name }}" 
                                       id="{{ form.username.id_for_label }}" 
                                       class="form-control" 
                                       value="{{ form.username.value|default:'' }}"
                                       placeholder="XXX.XXX.XXX-XX"
                                       autocomplete="off"
                                       data-autocomplete="true">
                                <div id="cpf-suggestions" class="position-absolute w-100 bg-white border rounded shadow-sm" style="display: none; z-index: 1000; max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            {% if form.username.help_text %}
                                <div class="form-text">{{ form.username.help_text }}</div>
                            {% endif %}
                            {% if form.username.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.username.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        {% endif %}
                        <div class="col-md-6">
                            {{ form.tipo_usuario|as_crispy_field }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            {{ form.first_name|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            {{ form.last_name|as_crispy_field }}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Se√ß√£o: Contato e Status -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-envelope me-2"></i>
                        Contato e Status
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            {{ form.email|as_crispy_field }}
                        </div>
                        <div class="col-md-6">
                            {{ form.ativo|as_crispy_field }}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Se√ß√£o: Seguran√ßa -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-lock me-2"></i>
                        {% if form.instance.pk %}
                            Alterar Senha (Opcional)
                        {% else %}
                            Seguran√ßa
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    {% if form.instance.pk %}
                        <!-- Informa√ß√µes da Senha Atual (para Administradores) -->
                        <div class="row mb-3">
                            <div class="col-md-8">
                                {{ form.senha_atual_info|as_crispy_field }}
                            </div>
                            <div class="col-md-4 d-flex align-items-end">
                                {% if user.tipo_usuario == 'administrador_sistema' %}
                                <a href="{% url 'core:redefinir_senha_usuario' pk=form.instance.pk %}" 
                                   class="btn btn-warning w-100" 
                                   title="Redefinir senha do usu√°rio">
                                    <i class="fas fa-key me-2"></i>
                                    Redefinir Senha
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Aviso sobre visualiza√ß√£o da senha -->
                        {% if user.tipo_usuario == 'administrador_sistema' %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Visualiza√ß√£o da Senha:</strong> A senha atual √© vis√≠vel apenas para administradores e expira em 24 horas por seguran√ßa.
                            <br><small class="text-muted">Ap√≥s a expira√ß√£o, use "Redefinir Senha" para gerar uma nova senha vis√≠vel.</small>
                        </div>
                        {% endif %}
                        
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Altera√ß√£o de Senha (Opcional):</strong> Os campos de senha est√£o em branco. 
                            <strong>Preencha apenas se desejar alterar a senha, ou deixe em branco para manter a senha atual.</strong>
                        </div>
                        
                        <!-- Op√ß√£o para gerar nova senha autom√°tica -->
                        <div class="row mb-3">
                            <div class="col-12">
                                {{ form.gerar_nova_senha|as_crispy_field }}
                            </div>
                        </div>
                        
                        <!-- Campos de senha (inicialmente ocultos) -->
                        <div id="password-fields" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    {{ form.password1|as_crispy_field }}
                                </div>
                                <div class="col-md-6">
                                    {{ form.password2|as_crispy_field }}
                                </div>
                            </div>
                        </div>
                    {% else %}
                        <div class="alert alert-success">
                            <i class="fas fa-key me-2"></i>
                            <strong>Senha √önica Gerada:</strong> Uma senha √∫nica e segura foi gerada automaticamente para este usu√°rio.
                            <br><small class="text-muted">A senha ser√° exibida ap√≥s a cria√ß√£o e deve ser alterada no primeiro acesso.</small>
                        </div>
                        
                        <div class="row">
                            {% if form.password1 %}
                            <div class="col-md-6">
                                <label for="{{ form.password1.id_for_label }}" class="form-label">
                                    Senha <span class="text-muted">(gerada automaticamente)</span>
                                </label>
                                <input type="password" name="{{ form.password1.name }}" id="{{ form.password1.id_for_label }}" class="form-control" value="{{ form.password1.initial }}" placeholder="Senha gerada automaticamente" readonly>
                                {% if form.password1.help_text %}
                                    <div class="form-text">{{ form.password1.help_text }}</div>
                                {% endif %}
                                {% if form.password1.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.password1.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}
                            {% if form.password2 %}
                            <div class="col-md-6">
                                <label for="{{ form.password2.id_for_label }}" class="form-label">
                                    Confirmar Senha <span class="text-muted">(gerada automaticamente)</span>
                                </label>
                                <input type="password" name="{{ form.password2.name }}" id="{{ form.password2.id_for_label }}" class="form-control" value="{{ form.password2.initial }}" placeholder="Confirma√ß√£o da senha gerada" readonly>
                                {% if form.password2.help_text %}
                                    <div class="form-text">{{ form.password2.help_text }}</div>
                                {% endif %}
                                {% if form.password2.errors %}
                                    <div class="invalid-feedback d-block">
                                        {% for error in form.password2.errors %}
                                            {{ error }}
                                        {% endfor %}
                                    </div>
                                {% endif %}
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}
                </div>
            </div>
            
            <!-- Bot√µes de a√ß√£o -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="card shadow">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <a href="{% url 'core:usuario_list' %}" class="btn btn-outline-secondary">
                                    <i class="fas fa-times me-1"></i>
                                    Cancelar
                                </a>
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>
                                    {% if form.instance.pk %}
                                        Atualizar Usu√°rio
                                    {% else %}
                                        Criar Usu√°rio
                                    {% endif %}
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    
    <!-- Painel lateral com informa√ß√µes e ajuda -->
    <div class="col-lg-4">
        <!-- Se√ß√£o de Cadastros Dispon√≠veis -->
        {% if total_cadastros_disponiveis > 0 %}
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h6 class="mb-0">
                    <i class="fas fa-users me-2"></i>
                    Cadastros Dispon√≠veis ({{ total_cadastros_disponiveis }})
                </h6>
            </div>
            <div class="card-body">
                <!-- Debug info -->
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Debug:</strong><br>
                    - Advogados: {{ advogados_disponiveis|length }}<br>
                    - Psic√≥logos: {{ psicologos_disponiveis|length }}<br>
                    - Associados: {{ associados_disponiveis|length }}<br>
                    - Total: {{ total_cadastros_disponiveis }}
                </div>
                
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Dica:</strong> Clique em um cadastro para preencher automaticamente os campos do usu√°rio.
                </div>
                
                <!-- Advogados -->
                {% if advogados_disponiveis %}
                <div class="mb-3">
                    <h6 class="text-primary">
                        <i class="fas fa-gavel me-2"></i>
                        Advogados ({{ advogados_disponiveis|length }})
                    </h6>
                    <div class="list-group list-group-flush">
                        {% for advogado in advogados_disponiveis %}
                        <div class="list-group-item list-group-item-action cursor-pointer cadastro-item" 
                             data-tipo="advogado"
                             data-cpf="{{ advogado.cpf }}"
                             data-nome="{{ advogado.nome }}"
                             data-email="{{ advogado.email }}"
                             data-oab="{{ advogado.oab }}"
                             data-uf="{{ advogado.uf_oab }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong class="d-block">{{ advogado.cpf }}</strong>
                                    <small class="text-muted">{{ advogado.nome }}</small>
                                    <br>
                                    <small class="text-muted">OAB: {{ advogado.oab }}/{{ advogado.uf_oab }}</small>
                                </div>
                                <span class="badge bg-success">Advogado</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Psic√≥logos -->
                {% if psicologos_disponiveis %}
                <div class="mb-3">
                    <h6 class="text-primary">
                        <i class="fas fa-brain me-2"></i>
                        Psic√≥logos ({{ psicologos_disponiveis|length }})
                    </h6>
                    <div class="list-group list-group-flush">
                        {% for psicologo in psicologos_disponiveis %}
                        <div class="list-group-item list-group-item-action cursor-pointer cadastro-item" 
                             data-tipo="psicologo"
                             data-cpf="{{ psicologo.cpf }}"
                             data-nome="{{ psicologo.nome_completo }}"
                             data-email="{{ psicologo.email }}"
                             data-crp="{{ psicologo.crp }}"
                             data-uf="{{ psicologo.uf_crp }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong class="d-block">{{ psicologo.cpf }}</strong>
                                    <small class="text-muted">{{ psicologo.nome_completo }}</small>
                                    <br>
                                    <small class="text-muted">CRP: {{ psicologo.crp }}/{{ psicologo.uf_crp }}</small>
                                </div>
                                <span class="badge bg-info">Psic√≥logo</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
                
                <!-- Associados -->
                {% if associados_disponiveis %}
                <div class="mb-3">
                    <h6 class="text-primary">
                        <i class="fas fa-user me-2"></i>
                        Associados ({{ associados_disponiveis|length }})
                    </h6>
                    <div class="list-group list-group-flush">
                        {% for associado in associados_disponiveis %}
                        <div class="list-group-item list-group-item-action cursor-pointer cadastro-item" 
                             data-tipo="associado"
                             data-cpf="{{ associado.cpf }}"
                             data-nome="{{ associado.nome }}"
                             data-email="{{ associado.email }}">
                            <div class="d-flex justify-content-between align-items-start">
                                <div>
                                    <strong class="d-block">{{ associado.cpf }}</strong>
                                    <small class="text-muted">{{ associado.nome }}</small>
                                </div>
                                <span class="badge bg-warning text-dark">Associado</span>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        <!-- Se√ß√£o de Dicas -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Dicas e Orienta√ß√µes
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-0">
                    <ul class="mb-0">
                        <li>O CPF deve estar no formato XXX.XXX.XXX-XX</li>
                        <li>O email deve ser √∫nico no sistema</li>
                        <li>Para usu√°rios associados, use o tipo "Associado"</li>
                        <li>Usu√°rios inativos n√£o conseguem fazer login</li>
                        {% if form.instance.pk %}
                        <li><strong>Os campos de senha v√™m em branco por padr√£o</strong></li>
                        <li>Preencha apenas se desejar alterar a senha</li>
                        <li>Deixe em branco para manter a senha atual</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Se√ß√£o de Aten√ß√µes -->
        {% if form.instance.pk %}
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Aten√ß√µes Importantes
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-warning mb-0">
                    <ul class="mb-0">
                        <li>Alterar a senha de um usu√°rio ir√° desconect√°-lo automaticamente</li>
                        <li>Certifique-se de que a nova senha seja segura (m√≠nimo 8 caracteres)</li>
                        <li>As altera√ß√µes de senha s√£o registradas no log do sistema</li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Se√ß√£o de Valida√ß√µes -->
        <div class="card mb-4">
            <div class="card-header">
                <h6 class="mb-0">
                    <i class="fas fa-check-circle me-2"></i>
                    Valida√ß√µes do Sistema
                </h6>
            </div>
            <div class="card-body">
                <div class="alert alert-success mb-0">
                    <ul class="mb-0">
                        <li>CPF ser√° validado automaticamente</li>
                        <li>Email deve ser √∫nico no sistema</li>
                        <li>Senha deve ter pelo menos 8 caracteres</li>
                        <li>Todos os campos obrigat√≥rios s√£o marcados com *</li>
                        {% if form.instance.pk %}
                        <li><strong>Campos de senha v√™m em branco por padr√£o</strong></li>
                        <li>Se preencher, ambos os campos devem ser preenchidos</li>
                        <li>As senhas devem ser id√™nticas</li>
                        <li>Deixe em branco para manter a senha atual</li>
                        {% endif %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
console.log('üöÄ Script carregado!');

$(document).ready(function() {
    console.log('‚úÖ Document ready!');
    console.log('üîç jQuery funcionando:', typeof $ !== 'undefined');
    
    // Teste simples
    $('body').append('<div id="teste" style="position: fixed; top: 10px; right: 10px; background: red; color: white; padding: 10px; z-index: 9999;">JavaScript Funcionando!</div>');
    
    // Verificar elementos
    console.log('üîç Elementos cadastro-item:', $('.cadastro-item').length);
    console.log('üîç Campo username:', $('#id_username').length);
    
    // Evento de clique para preencher formul√°rio
    $(document).on('click', '.cadastro-item', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        console.log('üéØ Clique detectado!');
        console.log('üîç Elemento clicado:', this);
        console.log('üîç Data attributes:', $(this).data());
        
        // Extrair dados do elemento clicado
        var tipo = $(this).data('tipo');
        var cpf = $(this).data('cpf');
        var nome = $(this).data('nome');
        var email = $(this).data('email');
        
        console.log('üîç Dados extra√≠dos:', { tipo, cpf, nome, email });
        
        // Preencher campo CPF (username)
        var usernameField = $('#id_username');
        if (usernameField.length) {
            usernameField.val(cpf);
            console.log('‚úÖ CPF preenchido:', cpf);
        } else {
            console.error('‚ùå Campo username n√£o encontrado');
        }
        
        // Preencher nome e sobrenome
        var nomeParts = nome.split(' ');
        var firstName = nomeParts[0];
        var lastName = nomeParts.slice(1).join(' ');
        
        // Campo first_name
        var firstNameField = $('input[name="first_name"]');
        if (firstNameField.length) {
            firstNameField.val(firstName);
            console.log('‚úÖ Nome preenchido:', firstName);
        } else {
            console.error('‚ùå Campo first_name n√£o encontrado');
        }
        
        // Campo last_name
        var lastNameField = $('input[name="last_name"]');
        if (lastNameField.length) {
            lastNameField.val(lastName);
            console.log('‚úÖ Sobrenome preenchido:', lastName);
        } else {
            console.error('‚ùå Campo last_name n√£o encontrado');
        }
        
        // Preencher email
        if (email) {
            var emailField = $('input[name="email"]');
            if (emailField.length) {
                emailField.val(email);
                console.log('‚úÖ Email preenchido:', email);
            } else {
                console.error('‚ùå Campo email n√£o encontrado');
            }
        }
        
        // Definir tipo de usu√°rio
        var tipoUsuarioField = $('#id_tipo_usuario');
        if (tipoUsuarioField.length) {
            tipoUsuarioField.val(tipo);
            console.log('‚úÖ Tipo de usu√°rio definido:', tipo);
        } else {
            console.error('‚ùå Campo tipo_usuario n√£o encontrado');
        }
        
        // Destacar o item selecionado
        $('.cadastro-item').removeClass('active');
        $(this).addClass('active');
        
        // Mostrar mensagem de sucesso
        mostrarMensagemSucesso('Cadastro selecionado! Campos preenchidos automaticamente.');
        
        // Focar no campo de senha
        var passwordField = $('#id_password1');
        if (passwordField.length) {
            passwordField.focus();
            console.log('‚úÖ Foco movido para campo de senha');
        }
        
        console.log('‚úÖ Preenchimento conclu√≠do com sucesso!');
    });
    
    // Fun√ß√£o para mostrar mensagem de sucesso
    function mostrarMensagemSucesso(mensagem) {
        // Remover mensagens anteriores
        $('.alert-success').remove();
        
        var alertHtml = '<div class="alert alert-success alert-dismissible fade show" role="alert">' +
                       '<i class="fas fa-check-circle me-2"></i>' + mensagem +
                       '<button type="button" class="btn-close" data-bs-dismiss="alert"></button>' +
                       '</div>';
        
        // Inserir mensagem no topo do formul√°rio
        $('.card:first').before(alertHtml);
        
        // Auto-remover ap√≥s 5 segundos
        setTimeout(function() {
            $('.alert-success').fadeOut();
        }, 5000);
        
        console.log('‚úÖ Mensagem de sucesso exibida:', mensagem);
    }
    
    // Debug: verificar todos os campos dispon√≠veis
    console.log('üîç Verificando todos os campos do formul√°rio...');
    $('input, select, textarea').each(function() {
        var $this = $(this);
        console.log('üîç Campo:', {
            name: $this.attr('name'),
            id: $this.attr('id'),
            type: $this.attr('type'),
            value: $this.val()
        });
    });
    
    // Garantir que os campos de senha tenham valores padr√£o
    $(document).ready(function() {
        // Verificar se √© um novo usu√°rio (n√£o tem PK)
        var isNewUser = !$('input[name="username"]').val() || $('input[name="username"]').val() === '';
        
        if (isNewUser) {
            console.log('üîç Configurando senhas √∫nicas para novo usu√°rio...');
            
            // Mostrar senha gerada (n√£o ocultar)
            var password1Field = $('#id_password1');
            var password2Field = $('#id_password2');
            
            if (password1Field.length && password2Field.length) {
                // Alterar tipo para text temporariamente para mostrar a senha
                password1Field.attr('type', 'text');
                password2Field.attr('type', 'text');
                
                // Adicionar bot√£o para alternar visibilidade
                password1Field.after('<button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="togglePasswordVisibility(\'id_password1\')"><i class="fas fa-eye"></i></button>');
                password2Field.after('<button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="togglePasswordVisibility(\'id_password2\')"><i class="fas fa-eye"></i></button>');
                
                console.log('‚úÖ Senhas √∫nicas configuradas e vis√≠veis');
            }
        }
        
        // Interceptar o envio do formul√°rio para garantir que as senhas sejam enviadas
        $('form').on('submit', function(e) {
            if (isNewUser) {
                var password1 = $('#id_password1').val();
                var password2 = $('#id_password2').val();
                
                console.log('üîç Verificando senhas antes do envio:', {
                    password1: password1,
                    password2: password2
                });
                
                // Garantir que ambos os campos tenham a mesma senha
                if (password1 && password2 && password1 !== password2) {
                    $('#id_password2').val(password1);
                    console.log('‚úÖ Senha 2 sincronizada com senha 1');
                }
            }
        });
    });
    
    // Fun√ß√£o para alternar visibilidade da senha
    function togglePasswordVisibility(fieldId) {
        var field = $('#' + fieldId);
        var button = field.next('button');
        var icon = button.find('i');
        
        if (field.attr('type') === 'password') {
            field.attr('type', 'text');
            icon.removeClass('fa-eye').addClass('fa-eye-slash');
            button.attr('title', 'Ocultar senha');
        } else {
            field.attr('type', 'password');
            icon.removeClass('fa-eye-slash').addClass('fa-eye');
            button.attr('title', 'Mostrar senha');
        }
    }
});
</script>

<!-- Scripts espec√≠ficos para edi√ß√£o de usu√°rios -->
<script>
    // Fun√ß√£o para controlar campos de senha na edi√ß√£o
    window.togglePasswordFields = function() {
        var checkbox = document.getElementById('id_gerar_nova_senha');
        var passwordFields = document.getElementById('password-fields');
        
        if (checkbox && passwordFields) {
            if (checkbox.checked) {
                passwordFields.style.display = 'block';
                
                // Gerar senha automaticamente
                var password1Field = document.getElementById('id_password1');
                var password2Field = document.getElementById('id_password2');
                
                if (password1Field && password2Field) {
                    // Gerar senha √∫nica
                    var senha = gerarSenhaUnica();
                    password1Field.value = senha;
                    password2Field.value = senha;
                    
                    // Mostrar mensagem
                    mostrarMensagemSucesso('Nova senha gerada automaticamente: ' + senha);
                }
            } else {
                passwordFields.style.display = 'none';
                
                // Limpar campos
                var password1Field = document.getElementById('id_password1');
                var password2Field = document.getElementById('id_password2');
                
                if (password1Field) password1Field.value = '';
                if (password2Field) password2Field.value = '';
            }
        }
    };
    
    // Fun√ß√£o para gerar senha √∫nica (mesma l√≥gica do backend)
    function gerarSenhaUnica() {
        var letras = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
        var senha = '';
        
        // Garantir pelo menos 2 de cada tipo
        senha += 'AB'; // 2 mai√∫sculas
        senha += 'ab'; // 2 min√∫sculas
        senha += '12'; // 2 n√∫meros
        senha += '!@'; // 2 especiais
        
        // Adicionar mais caracteres aleat√≥rios
        for (var i = 0; i < 4; i++) {
            senha += letras.charAt(Math.floor(Math.random() * letras.length));
        }
        
        // Embaralhar a senha
        return senha.split('').sort(function() { return 0.5 - Math.random(); }).join('');
    }
</script>
{% endblock %}
