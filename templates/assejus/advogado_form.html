{% extends 'base.html' %}

{% block title %}
    {% if form.instance.pk %}Editar Advogado{% else %}Novo Advogado{% endif %} - ASEJUS
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-balance-scale me-2"></i>
        {% if form.instance.pk %}
            Editar Advogado
        {% else %}
            Novo Advogado
        {% endif %}
    </h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{% url 'assejus:advogado_list' %}" class="btn btn-sm btn-secondary">
                <i class="fas fa-arrow-left me-1"></i>
                Voltar
            </a>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card shadow">
            <div class="card-header py-3">
                <h6 class="m-0 font-weight-bold text-primary">
                    <i class="fas fa-user-edit me-2"></i>
                    {% if form.instance.pk %}
                        Editar Dados do Advogado
                    {% else %}
                        Cadastrar Novo Advogado
                    {% endif %}
                </h6>
            </div>
            <div class="card-body">
                <form method="post" class="needs-validation" enctype="multipart/form-data" novalidate>
                    {% csrf_token %}
                    
                    <!-- Dados Pessoais -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">
                                <i class="fas fa-user me-2"></i>
                                Dados Pessoais
                            </h5>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.nome.id_for_label }}" class="form-label">
                                {{ form.nome.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.nome }}
                            {% if form.nome.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.nome.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.cpf.id_for_label }}" class="form-label">
                                {{ form.cpf.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.cpf }}
                            {% if form.cpf.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.cpf.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.oab.id_for_label }}" class="form-label">
                                {{ form.oab.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.oab }}
                            {% if form.oab.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.oab.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.uf_oab.id_for_label }}" class="form-label">
                                {{ form.uf_oab.label }} <span class="text-danger">*</span>
                            </label>
                            <select name="{{ form.uf_oab.name }}" id="{{ form.uf_oab.id_for_label }}" class="form-control">
                                {% for choice in form.uf_oab.field.choices %}
                                    <option value="{{ choice.0 }}" {% if choice.0 == form.uf_oab.value %}selected{% endif %}>
                                        {{ choice.1 }}
                                    </option>
                                {% endfor %}
                            </select>
                            {% if form.uf_oab.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.uf_oab.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Selecione o estado da OAB</div>
                        </div>
                    </div>

                    <!-- Dados de Contato -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">
                                <i class="fas fa-address-book me-2"></i>
                                Dados de Contato
                            </h5>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email.id_for_label }}" class="form-label">
                                {{ form.email.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.email }}
                            {% if form.email.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.email.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.telefone.id_for_label }}" class="form-label">
                                {{ form.telefone.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.telefone }}
                            {% if form.telefone.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.telefone.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.celular.id_for_label }}" class="form-label">
                                {{ form.celular.label }}
                            </label>
                            {{ form.celular }}
                            {% if form.celular.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.celular.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Endereço -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">
                                <i class="fas fa-map-marker-alt me-2"></i>
                                Endereço
                            </h5>
                        </div>
                        <div class="col-12 mb-3">
                            <label for="{{ form.endereco.id_for_label }}" class="form-label">
                                {{ form.endereco.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.endereco }}
                            {% if form.endereco.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.endereco.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.cidade.id_for_label }}" class="form-label">
                                {{ form.cidade.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.cidade }}
                            {% if form.cidade.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.cidade.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.estado.id_for_label }}" class="form-label">
                                {{ form.estado.label }} <span class="text-danger">*</span>
                            </label>
                            <select name="{{ form.estado.name }}" id="{{ form.estado.id_for_label }}" class="form-control">
                                {% for choice in form.estado.field.choices %}
                                    <option value="{{ choice.0 }}" {% if choice.0 == form.estado.value %}selected{% endif %}>
                                        {{ choice.1 }}
                                    </option>
                                {% endfor %}
                            </select>
                            {% if form.estado.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.estado.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Selecione o estado do endereço</div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.cep.id_for_label }}" class="form-label">
                                {{ form.cep.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.cep }}
                            {% if form.cep.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.cep.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Foto -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">
                                <i class="fas fa-camera me-2"></i>
                                Foto
                            </h5>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.foto.id_for_label }}" class="form-label">
                                {{ form.foto.label }}
                            </label>
                            {{ form.foto }}
                            {% if form.foto.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.foto.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Formatos aceitos: JPG, PNG, GIF. Tamanho máximo: 10MB</div>
                        </div>
                        {% if form.instance.foto %}
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Foto Atual</label>
                            <div>
                                <img src="{{ form.instance.foto.url }}" alt="Foto atual" class="img-thumbnail" style="max-width: 200px;">
                            </div>
                        </div>
                        {% endif %}
                    </div>

                    <!-- Dados Profissionais -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">
                                <i class="fas fa-briefcase me-2"></i>
                                Dados Profissionais
                            </h5>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ form.especialidades.id_for_label }}" class="form-label">
                                {{ form.especialidades.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.especialidades }}
                            <div class="form-text">Separe as especialidades por vírgula (ex: Direito Civil, Direito Penal)</div>
                            {% if form.especialidades.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.especialidades.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.data_inscricao_oab.id_for_label }}" class="form-label">
                                {{ form.data_inscricao_oab.label }} <span class="text-danger">*</span>
                            </label>
                            <input type="date" 
                                   name="{{ form.data_inscricao_oab.name }}" 
                                   id="{{ form.data_inscricao_oab.id_for_label }}" 
                                   class="form-control"
                                   value="{% if form.data_inscricao_oab.value %}{{ form.data_inscricao_oab.value|date:'Y-m-d' }}{% endif %}"
                                   placeholder="DD/MM/AAAA">
                            {% if form.data_inscricao_oab.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.data_inscricao_oab.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            <div class="form-text">Formato: DD/MM/AAAA</div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label for="{{ form.experiencia_anos.id_for_label }}" class="form-label">
                                {{ form.experiencia_anos.label }} <span class="text-danger">*</span>
                            </label>
                            {{ form.experiencia_anos }}
                            {% if form.experiencia_anos.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.experiencia_anos.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Status e Observações -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5 class="border-bottom pb-2">
                                <i class="fas fa-cog me-2"></i>
                                Ativo e Observações
                            </h5>
                        </div>

                        <div class="col-md-12 mb-3">
                            <div class="form-check mt-4">
                                {{ form.ativo }}
                                <label class="form-check-label" for="{{ form.ativo.id_for_label }}">
                                    {{ form.ativo.label }}
                                </label>
                            </div>
                            {% if form.ativo.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.ativo.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                        <div class="col-12 mb-3">
                            <label for="{{ form.observacoes.id_for_label }}" class="form-label">
                                {{ form.observacoes.label }}
                            </label>
                            {{ form.observacoes }}
                            {% if form.observacoes.errors %}
                                <div class="invalid-feedback d-block">
                                    {% for error in form.observacoes.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Botões de Ação -->
                    <div class="row">
                        <div class="col-12 text-end">
                            <a href="{% url 'assejus:advogado_list' %}" class="btn btn-secondary me-2">
                                <i class="fas fa-times me-1"></i>
                                Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>
                                {% if form.instance.pk %}
                                    Atualizar
                                {% else %}
                                    Cadastrar
                                {% endif %}
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.card {
    border: none;
    box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
}
.card-header {
    background-color: #f8f9fc;
    border-bottom: 1px solid #e3e6f0;
}
.border-bottom {
    border-bottom: 1px solid #e3e6f0 !important;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Validação do formulário
(function() {
    'use strict';
    window.addEventListener('load', function() {
        var forms = document.getElementsByClassName('needs-validation');
        var validation = Array.prototype.filter.call(forms, function(form) {
            form.addEventListener('submit', function(event) {
                if (form.checkValidity() === false) {
                    event.preventDefault();
                    event.stopPropagation();
                }
                form.classList.add('was-validated');
            }, false);
        });
    }, false);
})();

// Máscara para CPF
document.addEventListener('DOMContentLoaded', function() {
    var cpfField = document.getElementById('{{ form.cpf.id_for_label }}');
    if (cpfField) {
        cpfField.addEventListener('input', function(e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                value = value.replace(/(\d{3})(\d{3})(\d{3})(\d{2})/, '$1.$2.$3-$4');
                e.target.value = value;
            }
        });
    }
    
    // Máscara para CEP
    var cepField = document.getElementById('{{ form.cep.id_for_label }}');
    if (cepField) {
        cepField.addEventListener('input', function(e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length <= 8) {
                value = value.replace(/(\d{5})(\d{3})/, '$1-$2');
                e.target.value = value;
            }
        });
    }
    
    // Inicialização do campo de data
    var dataInscricaoField = document.getElementById('{{ form.data_inscricao_oab.id_for_label }}');
    if (dataInscricaoField) {
        console.log('Campo de data de inscrição encontrado:', dataInscricaoField);
        console.log('Valor atual:', dataInscricaoField.value);
        console.log('Tipo do campo:', dataInscricaoField.type);
        
        // Se o campo estiver vazio mas tivermos dados iniciais, preenchemos
        if (!dataInscricaoField.value && '{{ form.initial.data_inscricao_oab }}') {
            dataInscricaoField.value = '{{ form.initial.data_inscricao_oab }}';
            console.log('Data preenchida com valor inicial:', dataInscricaoField.value);
        }
    }
    
    // Verifica se os campos de UF estão sendo exibidos corretamente
    var ufOabField = document.getElementById('{{ form.uf_oab.id_for_label }}');
    var estadoField = document.getElementById('{{ form.estado.id_for_label }}');
    
    if (ufOabField) {
        console.log('Campo UF OAB encontrado:', ufOabField);
        console.log('Opções disponíveis:', ufOabField.options.length);
        console.log('Valor selecionado:', ufOabField.value);
    }
    
    if (estadoField) {
        console.log('Campo Estado encontrado:', estadoField);
        console.log('Opções disponíveis:', estadoField.options.length);
        console.log('Valor selecionado:', estadoField.value);
    }
    
    // Adiciona formatação automática para telefone
    var telefoneField = document.getElementById('{{ form.telefone.id_for_label }}');
    if (telefoneField) {
        telefoneField.addEventListener('input', function(e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                if (value.length <= 10) {
                    value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                } else {
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                }
                e.target.value = value;
            }
        });
    }
    
    // Adiciona formatação automática para celular
    var celularField = document.getElementById('{{ form.celular.id_for_label }}');
    if (celularField) {
        celularField.addEventListener('input', function(e) {
            var value = e.target.value.replace(/\D/g, '');
            if (value.length <= 11) {
                if (value.length <= 10) {
                    value = value.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                } else {
                    value = value.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                }
                e.target.value = value;
            }
        });
    }
});
</script>
{% endblock %}
